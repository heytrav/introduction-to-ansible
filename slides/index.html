<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Introduction to automation with Ansible - Catalyst</title>

        <meta name="author" content="Catalyst">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/catalyst.css" id="theme">
        <link rel="stylesheet" href="css/asciinema-player.css">

        <!-- For syntax highlighting -->
        <!-- <link rel="stylesheet" href="lib/css/zenburn.css"> -->
        <link rel="stylesheet" href="lib/css/solarized-light.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <style>
            /* Add the ability to omit slides from the printed version (has to be after the print include)*/
            @media print {
                .reveal .slides section.no-print {
                    display: none !important;
                    visibility: hidden !important;
                }
            }
        </style>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Please put any custom styles here -->
        <style>

        </style>
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <!-- Cover slide -->
                <section>
                    <h3>Introduction to automation with Ansible</h3>
                    <h1 class="catalyst-logo">Catalyst</h1>
                    <p class="small-text">
                        Presented by <a href="#">Travis Holton</a>
                    </p>
                </section>


                <!--Remove -->

                <!--<section>
                    <h3>Lets play a game!</h3>
                </section>-->

                <section>
                    <h3>About this course</h3>
                    <ul>
                        <li>Assumes little or no experience with Ansible</li>
                        <li>Assumes some familiarity with the Linux command line</li>
                        <li>Assumes we are using Ubuntu (trusty)</li>
                    </ul>
                </section>

                <section>
                <section>
                    <h3>Course aims - Automation</h3>
                    <ul>
                        <li>Understand why automation is important</li>
                        <li>Understand what automation tools are available and how Ansible compares</li>
                        <li>
                            Explore Ansible basics
                        </li>
                        <li>
                            Emphasis on practical understanding of Ansible
                        </li>
                    </ul>
                </section>



                <section>
                    <h3>Course aims - Ansible</h3>
                    <ul>
                        <li>Learn how to install Ansible</li>
                        <li>Understand the basics of how Ansible works</li>
                        <li>Gain familiarity with the <a href="https://docs.ansible.com/ansible/latest/index.html">Ansible Documentation</a></li>
                        <li>Gain Awareness of Ansible Best Practices</li>
                        <li>Gain hands on experience writing and running playbooks</li>
                    </ul>
                </section>
                </section>

                <section>

                <section>
                    <h2>
                        Why use automation tools?
                    </h2>
                </section>

<section>
                    <h3>What does Automation enable?</h3>
                    
                    <img class="fragment" data-fragment-index="0" src="img/old-timer.jpg"
                    style="float:left;width:30%;margin-right:5px;" />
                    <img src="img/robot.jpg" class="fragment"
                                             data-fragment-index="1"
                    style="float:left;width:30%;margin-right:5px;" />
                    <img src="img/mass-cars.jpg" style="float:left;width:30%;"
                    class="fragment" data-fragment-index="2"/>
                </section>
                <section>
                    <h3>
                        Typical application
                    </h3>
<div style="width:50%;float:left;">
                        <img src="img/application-network.svg" alt="basic app
                        network"  >
                    </div>
                    <div style="width:50%;float:left;">
                        <ul style="font-size:18pt;"><li>
                                Applications have many components
                                <ul style="font-size:16pt;">
                                    <li class="fragment" data-fragment-index="0">Web servers</li>
                                    <li class="fragment" data-fragment-index="1">App servers</li>
                                    <li class="fragment" data-fragment-index="2">Load balancers</li>
                                    <li class="fragment" data-fragment-index="3">Database</li>
                                    <li class="fragment" data-fragment-index="4">Caching systems</li>
                                    <li class="fragment" data-fragment-index="5">
                                        Network infrastructure: firewalls, subnets
                                        routers, etc.
                                    </li>


                                </ul>
                            </li>

                                    <li class="fragment"
                                        data-fragment-index="6">Spread across multiple
                                        regions for redundancy</li>
                        </ul>
                    </div>
                    
                </section>
                <section>
                    <h3>
                        Disadvantages of manual deployment
                    </h3>
                    <ul>
                    <li class="fragment" data-fragment-index="0">
                        You could login to every machine in your network to
                        <ul>
                            <li>install packages</li>
                            <li>update configuration</li>
                            <li>deploy code</li>
                        </ul>
                    </li>
                        <li class="fragment" data-fragment-index="1">Time consuming</li>
                        <li class="fragment" data-fragment-index="2">Error prone</li>
                    </ul>
                    


                </section>
                <section>
                    <h3>What is Automation?</h3>
                    <ul>
                        <li class="fragment" data-fragment-index="0">Automation is about taking manual processes and placing technology around them to make them repeatable.</li>
                        <li class="fragment" data-fragment-index="1">Automation is the key to speed, consistency, scalability and repeatability.</li>
                    </ul>
                </section>
            
                <section>
                    <h3>Discussion</h3>
                    
                    <ul>
                        <li>Lets take a minute to discuss automation
                            <ul>
                                <li>What do people think of in context of
                                    automation?</li>
                                <li>pros and cons</li>
                            </ul>
                        </li>
                    </ul>
                    
                </section>
<section>
                    <h3>Benefits of Automation</h3>
                    <ul>
                        <li>Scalability</li>
                        <li>Reliability</li>
                        <li>Duplication</li>
                        <li>Consistency</li>
                        <li>Auditability</li>
                        <li>Security</li>
                    </ul>
                </section>




                

                
                <section>
                    <h3>How automation helps organisations succeed</h3>
                    <ul>
                        <li>Achieve high deployment frequency</li>
                        <li>Decouple deployments from releases</li>
                    </ul>
                </section>
                <section>
                    <h3>High deployment frequency</h3>
                    <ul>
                        <li>Frequent releases of small features</li>
                        <li>Fast delivery of value to the customer</li>
                        <li>Per release risk is lower</li>
                        <li>Faster MTTR</li>
                        <li>Shorter feedback loops to validate value for users</li>
                    </ul>
                    <aside class="notes">
                        MTTR - mean time to recovery
                    </aside>
                </section>
                <section>
                    <h3>Faster and better?</h3>
                    <p><a href="https://www.thoughtworks.com/profiles/jez-humble">Jez Humbles</a> research on high performing organizations shows that faster and better is possible.</p>
                    <ul>
                        <li>Higher Quality</li>
                        <li>Faster Delivery</li>
                        <li>Greater Business Responsiveness</li>
                        <li>Reduced Costs</li>
                    </ul>
                </section>
                
                <section>
                    <h3>Recommended reading</h3>
                    <ul>
                        <li>Continuous Delivery by David Farley and Jez Humble</li>
                        <li>The DevOps Handbook by Gene Kim, Jez Humble, Patrick Debois and John Willis</li>
                        <li>Lean Enterprise by Barry O'Reilly, Jez Humble, and Joanne Molesky</li>
                        <li>The Phoenix Project by Gene Kim, George Spafford, and Kevin Behr</li>
                    </ul>
                </section>
                </section>
                <section>
                    <section>
                        <h2>
                            Types of Automation
                        </h2>
                    </section>

                <section>
                    <h3>Types of Automation</h3>
                    <ul>
                        <li>Provisioning</li>
                        <li>Configuration Management</li>
                        <li>Application Deployment and Continuous Delivery</li>
                        <li>Security &amp; Compliance</li>
                        <li>Orchestration</li>
                    </ul>
                </section>
                <!--<section>
                    <h3>Teachback - Ansible use cases</h3>
                    <p>Each group will review a one of the Ansible <a href="https://www.ansible.com/use-cases">use cases</a> and explain it to the class.</p>
                    <ul>
                        <li><a href="https://www.ansible.com/use-cases/provisioning">Provisioning</a></li>
                        <li><a href="https://www.ansible.com/use-cases/application-deployment">Application Deployment</a></li>
                        <li><a href="https://www.ansible.com/use-cases/configuration-management">Configuration Management</a></li>
                        <li><a href="https://www.ansible.com/use-cases/continuous-delivery">Continuous Delivery</a></li>
                        <li><a href="https://www.ansible.com/use-cases/security-and-compliance">Security &amp; Compliance</a></li>
                        <li><a href="https://www.ansible.com/use-cases/orchestration">Orchestration</a></li>
                    </ul>
                </section>-->
                <section>
                    <h3>Provisioning</h3>
                    <ul>
                        <li>
                            The act of creating a server, network router,
                            loadbalancer, etc. from some type of image
                        </li>
                        <li>Can be on bare metal or in cloud hosted
                            virtualisation</li>
                        <li>Example: Installation of centos image on a virtual
                        host</li>
                    </ul>
                </section>
                <section>
                    <h3>Provisioning Tools</h3>
                    <ul>
                        <li>Red Hat Kickstart</li>
                        <li><a href="http://fai-project.org/">FAI</a></li>
                        <li>Debian Preseed</li>
                        <li>Cobbler</li>
                        <li>
                            <a href="https://www.ansible.com/">Ansible</a>
                        </li>
                    </ul>
                </section>
                <section>
                    <h3>Configuration Management</h3>
                    <ul>
                        <li>Best known, often equated with "Automation"</li>
                        <li>Determining the state servers/applications should be in and
                            making sure that conditions are met</li>
                        <li>Agentless vs Agents</li>
                        <li>Often declarative syntax</li>
                    </ul>
                </section>
                <section>
                    <h3>Configuration Management</h3>
                    <ul>
                        <li><a href="https://saltstack.com/">Salt</a></li>
                        <li><a href="https://puppetlabs.com/">Puppet</a></li>
                        <li><a href="https://www.chef.io/">Chef</a></li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Application Deployment</h3>
                    <ul>
                        <li>
                            Take an artefact of development
                            <ul>
                                <li>libraries</li>
                                <li>executable code</li>
                            </ul>
                        </li>
                        <li>
                            Place it on server(s)
                        </li>

                        <li>
                            Make sure it runs on the server
                        </li>

                    
                        <li>Overlaps/integrates with CI/CD tools (eg Jenkins)</li>
                        <li>Quite often bespoke software</li>
                    </ul>
                </section>
                <section>
                    <h3>Application Deployment</h3>
                    <ul>
                        <li><a href="http://www.fabfile.org/">Fabric</a></li>
                        <li><a href="http://capistranorb.com/">Capistrano</a></li>
                        <li><a href="https://www.thoughtworks.com/go/">GoCD</a></li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Orchestration</h3>
                    <ul>
                        <li>
                            Concerned with automating workflows/processes
                        </li>
                        <li>
                            Interconnecting components of an application
                            <ul>
                                <li>webservers</li>
                                <li>databases</li>
                                <li>message queues</li>
                                <li>application</li>
                            </ul>
                        </li>
                        <li>
                            Makes sure components function together as a unit
                        </li>
                    </ul>
                </section>
                <section>
                    <h3>Orchestration</h3>
                    <ul>
                        <li><a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a></li>
                        <li><a href="https://wiki.openstack.org/wiki/Heat">OpenStack Heat</a></li>
                        <li><a href="https://www.redhat.com/en/technologies/cloud-computing/cloudforms">Red Hat CloudForms</a></li>
                        <li><a href="https://www.terraform.io/">Hashicorp Terraform</a></li>
                        <li>
                            Docker
                            <ul>
                                <li><a href="https://docs.docker.com/engine/swarm/">Swarm</a></li>
                                <li><a href="https://kubernetes.io/">Kubernetes</a></li>
                            </ul>
                        </li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Security &amp; Compliance</h3>
                    <ul>
                        <li>
                            Usually driven by some legislative or regulatory law
                            <ul>
                                <li>
                                    Designed to prevent unwanted
                                    disclosure, alteration or destruction of
                                    sensitive information
                                </li>
                                <li>PCI or government security standard compliance</li>
                            </ul>
                        </li>
                        <li>
                            Often subject to audit
                        </li>
                        <li>Automation removes complexity of managing security
                            in systems
                        </li>
                    </ul>
                </section>
                <section>
                    <h3>Security &amp; Compliance</h3>
                    <ul>
                        <li>Chef Inspec</li>
                        <li>Goss (go)</li>
                        <li>testinfra (python)</li>
                        <li><a href="http://serverspec.org/">Serverspec</a> (ruby)</li>
                    </ul>
                </section>
                <!--<section>
                    <h3>Teachback - Automation tools</h3>
                    <aside class="notes">Choose an automation tool to research, spend a few minutes reading up on it, then report back to the class describing its use case and five important facts about it.</aside>
                    <p>Choose from the list below or choose something yourself.</p>
                    <ul>
                        <li><a href="https://www.terraform.io"></a>Terraform</li>
                        <li><a href="https://www.chef.io/chef/"></a>Chef</li>
                        <li><a href="https://aws.amazon.com/cloudformation/"></a>AWS CloudFormation</li>
                        <li><a href="https://puppet.com/"></a>Puppet</li>
                        <li><a href="https://saltstack.com/"></a>Salt</li>
                        <li><a href="http://capistranorb.com/"></a>Capistrano</li>
                        <li><a href="https://theforeman.org/"></a>Foreman</li>
                        <li><a href="https://www.gocd.org/">GoCD</a></li>
                        <li><a href="https://cfengine.com/">CFEngine</a></li>
                    </ul>
                </section>-->
                </section>

                <section>
                    <section>
                        <h3>
                            What is Ansible?
                        </h3>
                    </section>
                    <section>
                        <h3>
                            Ansible is a tool for:
                        </h3>
                        <ul>
                            <li>Configuration management</li>
                            <li>Deployment</li>
                            <li>Orchestration</li>
                            <li>Provisioning</li>
                        </ul>
                    </section>
                <section>
                    <h3>Ansible Features</h3>
                    <ul>
                        <li>Based on Python</li>
                        <li>Agentless (nothing to install on remote host)</li>
                        <li>Only requires SSH and Python 2.4 or 2.5</li>
                        <li><em>Push</em> based</li>
                    </ul>
                </section>

                </section>

                <section>
                    <section>
                        <h2>
                            First steps with Ansible
                        </h2>
                    </section>


                    <section>
                        <h3>Installing Ansible</h3>


                        <ul>
                            <li>
                                Target Ansible version &ge; 2.4.2.0
                            </li>
                            <li><a
                               href="http://docs.ansible.com/ansible/latest/intro_installation.html">
                                    Offical documentation</a></li>

                            <li>
                                Explore a couple approaches using:
                                <ul>
                                    <li>OS package manager</li>
                                    <li>Python package manager (pip)</li>
                                </ul>
                            </li>
                        </ul>
                        <aside class="notes">
                            Users should become familiar with Ansible's online docs,
                            therefore many slides will reference those pages directly.
                        </aside>
                    </section>
                    
                    <section>
                        <h3>Requirements</h3>
                        <ul>
                            <li>Requires Python 2.6 or 2.7 on the control machine</li>
                            <li>Requires Python 2.6 on managed nodes</li>
                            <li>Python 3 support is currently a tech preview</li>
                        </ul>
                    </section>

                    <section>
                        <h4>
                            Ansible in this course
                        </h4>
                        <ul style="width:90%;">
                            <li class="fragment" data-fragment-index="0">The following slides describe alternative ways to install Ansible</li>
                            <li class="fragment" data-fragment-index="1">However, Ansible is already installed on your PCs</li>
                            <li class="fragment" data-fragment-index="2">
                                To activate:
                                <pre><code data-trim>
                                      $ source ~/catalystcloud-ansible/ansible-venv/bin/activate
                                </code></pre>
                            </li>
                        </ul>

                    </section>
                    <section>
                        <h3>Install Ansible using OS packages</h3>
                        <p>
                        Ansible version available with OS typically a bit out of
                        date
                        </p>
                        <asciinema-player autoplay="0"  loop="loop" font-size="medium" speed="1"
                                                                                       theme="solarized-light" src="lib/apt-cache-policy-ansible.json" cols="200" rows="10"></asciinema-player>

                                                                                   <p>
                                                                                   Add PPA and install from latest source for OS (See
                                                                                   <a href="http://docs.ansible.com/ansible/latest/intro_installation.html#installing-the-control-machine">documentation</a>)
                                                                                   </p>
                    </section>

                    <section>
                        <h3>Installing Ansible in Python virtual environment</h3>
                        <ul>
                            <li><a href="https://pip.pypa.io/en/stable/">PIP</a> - PyPAs <a href="https://packaging.python.org/guides/tool-recommendations/">recommended tool</a> for installing Python packages.</li>
                            <li><a href="https://pypi.python.org/pypi/virtualenv">Virtualenv</a> - PyPAs <a href="https://packaging.python.org/guides/tool-recommendations/">recommended tool</a> for creating isolated Python environments</li>
                            <li>PyPA = Python Packaging Authority</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Install Python Tools</h3>
                        <pre><code data-trim contenteditable>
$ sudo apt-get update
$ sudo apt-get upgrade
$ sudo apt-get install python-pip python-virtualenv
                        </code></pre>
                    </section>
                    <section>
                        <h3>Installing Ansible in Python virtual environment</h3>
                        <pre><code data-trim contenteditable>
$ virtualenv ansible-venv
$ source ansible-venv/bin/activate
(ansible-venv) $ pip install -U pip
(ansible-venv) $ pip install ansible
                        </code></pre>
                        <ul>
                            <li>Create a python virtual environment named <em>ansible-venv</em></li>
                            <li>Activate ansible-venv as base of Python interpreter</li>
                            <li>Update Python package manager (pip)</li>
                            <li>Use Python package manager to install Ansible</li>
                        </ul>

                    </section>
                    <!--<section>
                        <h3>Understanding Virtual Environments</h3>
                        <pre><code data-trim contenteditable>
$ which ansible
/home/train/ansible-venv/bin/ansible
$ ansible --version
ansible 2.4.1.0
  config file = None
  configured module search path = [u'/home/train/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /home/train/ansible-venv/local/lib/python2.7/site-packages/ansible
  executable location = /home/train/ansible-venv/bin/ansible
  python version = 2.7.6 (default, Oct 26 2016, 20:30:19) [GCC 4.8.4]
                        </code></pre>
                    </section>
                    <section>
                        <h3>Understanding Virtual Environments</h3>
                        <pre><code data-trim contenteditable>
$ env | grep PATH
PATH=/home/train/ansible-venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
$ which ansible
/home/train/ansible-venv/bin/ansible
$ deactivate
                        </code></pre>
                    </section>
                    <section>
                        <h3>Understanding Virtual Environments</h3>
                        <pre><code data-trim contenteditable>
$ which ansible
$ ansible --version
The program 'ansible' is currently not installed. You can install it by typing:
sudo apt install ansible
$ /home/train/ansible-venv/bin/ansible --version
                        </code></pre>
                    </section>-->

                    <section>
                        <h3>Releases</h3>
                        <ul>
                            <li>It is worth keeping up to date with Ansible <a href="https://docs.ansible.com/ansible/latest/release_and_maintenance.html">releases</a></li>
                            <li>Use pip or a PPA to get a recent version</li>
                            <li>Ansible is developed and released on a flexible 4 months release cycle</li>
                            <li>Ansible supports the two most recent major stable releases</li>
                        </ul>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>
                            Ansible Basics
                        </h2>
                    </section>

                <section>
                    <h3>Ansible Basics</h3>
                    <h4>
                        Terminology
                    </h4>
                    <div style="width:50%;float:left;">
                        <dl>
                            <dt>Task      </dt> <dd>   An action to perform</dd>
                            <dt>Play      </dt> <dd>   a collection of tasks</dd>
                            <dt>Playbook</dt>   <dd> YAML file containing one or more plays</dd>
                        </dl>
                    </div>
                    <div style="width:50%;float:left;">
                        <img src="img/ansible-workflow.png" />
                    </div>
                </section>
                <section>
                    <h3>Ansible Basics</h3>
                    <h4>
                        More Terminology
                    </h4>
                    <dl>
                        <dt>Module    </dt> <dd>Blob of Python code which is executed to perform task</dd>
                        <dt>Inventory </dt> <dd>File containing hosts and groups of hosts to run tasks</dd>
                    </dl>
                    
                </section>
                </section>
                <section>
                    <section>
                        <h2>
                            Running Ansible
                        </h2>
                    </section>
                <section>
                    <h3>
                        Running Ansible
                    </h3>
                    <ul>
                        <li class="fragment" data-fragment-index="0">
                            There are two ways to run ansible:
                            <ul>
                                <li class="fragment" data-fragment-index="1">
                                    ad hoc
                                    <ul>
                                        <li class="fragment" data-fragment-index="2">Run a single task
                                            
                                        
                                        </li>
                                        <li class="fragment" data-fragment-index="3"><code>ansible &lt;pattern&gt; [options]</code></li>
                                    </ul>
                                </li>

                                <li class="fragment" data-fragment-index="4">
                                    playbook
                                    <ul>
                                        <li>Run multiple tasks sequentially</li>
                                        <li><code>ansible-playbook &lt;pattern&gt; [options]</code></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        
                    </ul>


                       
                </section>
                    <section>
                        <h3>
                           Ad hoc tasks with Ansible
                        </h3>

                        <p>
                        <code>ansible &lt;pattern&gt; [options]</code>
                        </p>
                        <div >
                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    Perform a few <em>ad hoc</em> operations with Ansible 
                                    <ul>
                                        <li>Check connection to server</li>
                                        <li>Install packages</li>
                                        <li>
                                            Run system commands
                                        </li>
                                    </ul>
                                </li>
                                
                            </ul>
                        </div>
                    
                    </section>

                    <section>
                        <h4>
                            Administrative note
                        </h4>

                        <p>
                        Note: in all the following examples, <code>WORKDIR</code>
                        is the path to the <code>introduction-to-ansible/sample-folders</code>directory
                        </p>
                        <pre><code data-trim>
                            $ echo $WORKDIR
                            /home/train/introduction-to-ansible/sample-code
                        </code></pre>
                    </section>
                    <section>
                        <h3>
                            Simulating a remote server
                        </h3>

                        <div style="height:50%;">
                            <img src="img/one-vagrant-vm.png" />
                        </div>
                        <ul>
<li class="fragment" data-fragment-index="0">
                                                 For demo purposes in this course we will be using <a
                                                     href="https://www.vagrantup.com/intro/index.html">Vagrant</a> to simulate
                                                  remote hosts.
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Instance(s) use a centos 7 image
                            </li>
                            
                        </ul>

                        <pre class="fragment" data-fragment-index="2"><code data-trim>
                                $ cd $WORKDIR/lesson1
                                $ vagrant up --provider virtualbox
                                .
                                
                                ==&gt; default: Machine booted and ready!
                            </code></pre>
                            <p class="fragment" data-fragment-index="3">
                            If all went well you now have a remote host to manage!
                            </p>
                    </section>


                <section>
                    <h3>
                        Executing a basic task
                    </h3>
                    <h4>
                        Ansible behind the scenes
                    </h4>
                        <ul>
                            <li class="fragment" data-fragment-index="0">Create SSH connection to a host or list of
                                hosts (group) in parallel</li>
                            <li class="fragment" data-fragment-index="1">
                                Copy a small blob of executable code to each remote
                                machine
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Performs task: execute the code; capturing return code and
                                output
                            </li>
                            <li class="fragment" data-fragment-index="3">Removes the blob of code</li>
                            <li class="fragment" data-fragment-index="4">Closes the SSH connection</li>
                            <li class="fragment" data-fragment-index="5">Report back on outcome of task</li>
                        </ul>
                </section>
                    <section>
                        <h4>
                            Connecting Ansible to your host
                        </h4>
                        <ul>
                            <li class="fragment"
                                data-fragment-index="0">Ansible works by
                                creating an SSH connection with remote hosts</li>
                            <li class="fragment" data-fragment-index="1">Need
                                a way to tell Ansible how to connect to our
                                Vagrant VM via SSH</li>
                        </ul>
                    </section>
<section>
                        <h3>
                            The Inventory File
                        </h3>
                        <h4>
                            Tell Ansible about remote hosts
                        </h4>
                        <div style="width:50%;float:left;"><ul >

                                <li class="fragment" data-fragment-index="0">
                                    A text file in <code>.ini</code> syntax
                                </li>
                                <li class="fragment" data-fragment-index="1">Identifies hosts for ansible to interact with
                                    <ul>
                                        <li>
                                            Each host on a separate line
                                        </li>
                                    </ul>
                                </li>

                                <li class="fragment"
                                    data-fragment-index="2">Provides optional arguments after host
                                    <ul>
                                        <li>connection information</li>
                                        <li>
                                            other arbitrary variables for
                                            specific host
                                        </li>
                                    </ul>
                                </li>

                            </ul></div>

                            <div class="fragment" data-fragment-index="1" style="float:left;width:50%;"><pre><code data-trim>
                            #sample inventory

                            web1.mycompany.com
                            web2.mycompany.com
                            app1.mycompany.com

                            db.mycompany.com
                            lb.mycompany.com

                            [auckland]
                            web1.mycompany.com
                            
                            [wellington]
                            web2.mycompany.com
                            </code></pre></div>
                            


                    </section>
                    <section>
                        <h3>
                            The Inventory File
                        </h3>
                        <h4>
                            Sample inventory file
                        </h4>
                        
                        <pre><code data-trim>
                                    [web]
                                    web1.mycompany.com ansible_host=152.240.43.12 opt2=arg2
                                    web2.mycompany.com

                                    [db]
                                    db1.mycompany.com

                                    [app]
                                    app1.mycompany.com
                                    app2.mycompany.com

                                    [lb]
                                    loadbalancer.mycompany.com
                        </code></pre>


                    </section>
                    
                    <section>
                        <h3>
                            The Inventory File
                        </h3>
                        <h4>
                            Grouping your remote hosts
                        </h4>
                        <div style="width:50%;float:left;"><ul>

                                <li class="fragment" data-fragment-index="0">
                                    Sections used to organise hosts into
                                    <em>groups</em>
                                    <ul>
                                        <li>functional roles</li>
                                        <li>separate regions</li>
                                    </ul>
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Either group or specific hosts can be used in
                                    ansible commands
                                </li>
                              

                            </ul></div>
                            <div class="fragment" data-fragment-index="0" style="width:50%;float:left">
                                <pre><code data-trim>
                                    # sample inventory
                                    [web]
                                    web1.mycompany.com
                                    web2.mycompany.com

                                    [app]
                                    app1.mycompany.com
                                    app2.mycompany.com

                                    [wellington]
                                    web1.mycompany.com
                                    app1.mycompany.com

                                    [auckland]
                                    web2.mycompany.com
                                    app2.mycompany.com

                                </code></pre>
                            </div>


                    </section>
                    <section>
                        <h3>
                            Our first inventory file
                        </h3>
                        <pre><code data-trim>
                            $ cat $WORKDIR/lesson1/ansible/hosts
                        </code></pre>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Our inventory file specifies single remote host: <em>myserver</em>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                To connect to our Vagrant VM we need to
                                set some special connection variables
                                <ul>
                                    <li><code>ansible_host</code></li>
                                    <li><code>ansible_user</code></li>
                                    <li><code>ansible_port</code></li>
                                    <li><code>ansible_private_key_file</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Variables specified on same line as host
                            </li>
                            
                        </ul>

                    </section>
                    
                    <section>
                        
                        <h4>
                            Exercise: edit your inventory file to fill in missing
                            connection information
                        </h4>
                        <pre><code data-trim>$ vagrant ssh-config
Host default
    HostName ???
    User ???
    Port ???
    .
    IdentityFile ???
    .
    
                        </code></pre>
                        <p>
                        Use the values from your host to fill in missing
                        arguments in <code>ansible/hosts</code>
                        </p>
                    </section>
                    <section>
                        <h3>
                            Running <em>ad hoc</em> Ansible commands
                        </h3>
                        <p>
                        <code>ansible &lt;host pattern&gt; [OPTIONS]</code>
                        </p>
                        <ul>
                            <li>
                                <em>host pattern</em> can be:
                                <ul>
                                    <li>the name of a specific host in inventory</li>
                                    <li>a <em>group</em> of hosts from the inventory</li>
                                </ul>
                            </li>

                        </ul>
                        <table class="fragment" data-fragment-index="1">
                            <tr>
                                <th>Option    </th>
                                <th>Argument                  </th>
                                <th>Description</th>
                            </tr>
                            <tr><td> -m              </td>  <td>string</td>  <td>  module name to execute; default to <em>command</em> module</td></tr>
                            <tr><td> -a              </td>  <td>string</td>  <td>  arguments to module</td></tr>
                            <tr><td> -i              </td>  <td>string</td> <td>                 path to inventory file </td></tr>
                            <tr><td> -b              </td>  <td></td>        <td>         Run operations with become</td></tr>
                            <tr><td> --become-method</td> <td>string</td>
                                <td>Which become method to use. Default sudo                                 </td></tr>
                        </table>
                    </section>
                    <section>
                        <h4>
                            Exercise: Ping our remote host
                        </h4>
                        <p class="fragment" data-fragment-index="0">
                        <a
                                            href="https://docs.ansible.com/ansible/latest/ping_module.html"><em>ping</em></a>
                        is an Ansible module that just checks whether or not
                        Ansible can create a SSH sessions with hosts.
                        </p></h4>
                        <p class="fragment" data-fragment-index="1">
                        Use the <em>ping</em> module to check if our host accepts SSH
                        connections
                        </p>
                        <pre class="fragment" data-fragment-index="2"><code
                        data-trim>$ ansible myserver -i ansible/hosts -m ping
myserver | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
                        </code></pre>
                        

                    </section>

                    <section>
                        <h3>
                            The ansible.cfg file
                        </h3>
                        <h4>
                            Simplify our inventory file
                        </h4>
                        <pre class="fragment" data-fragment-index="0"><code data-trim>
    # sample ansible.cfg

    [defaults]
    inventory = hosts
    remote_user = vagrant
    private_key_file = .vagrant/machines/default/virtualbox/private_key
    host_key_checking = False
                            </code></pre>    
                        
                            <ul>
                                <li class="fragment" data-fragment-index="1">
                                    A way to set some defaults for ansible
                                    instead of in inventory file

                                </li>
                                <li class="fragment" data-fragment-index="2">
                                    .ini syntax
                                </li>
                                <li class="fragment" data-fragment-index="3">
                                    Specify SSH connection, which inventory
                                    file to use
                                </li>
                            </ul>
                    </section>
                    <section>
                        <h3>
                            The ansible.cfg file
                        </h3>
                        <h4>
                            Where Ansible looks for it
                        </h4>

                        <ul>
                            <li class="fragment" data-fragment-index="0">4 possible locations in order of priority
                                <ul>
                                    <li class="fragment" data-fragment-index="1">File specified by ANSIBLE_CONFIG</li>
                                    <li class="fragment" data-fragment-index="2">Current directory (<code>ansible.cfg</code>)</li>
                                    <li class="fragment" data-fragment-index="3">Home directory (<code>~/.ansible.cfg</code>)</li>
                                    <li class="fragment" data-fragment-index="4">/etc/ansible/ansible.cfg</li>
                                </ul>
                            </li>
                        </ul>
                        
                    </section>
                    <section>
                        <h4>
                            Exercise: Set up ansible.cfg and modify inventory file
                        </h4>
                        <p>
                        <code>$WORKDIR/ansible.cfg.sample</code>
                        </p>
                        <p>
                        Use config to simplify your inventory file.
                        </p>
                        
<pre class="fragment" data-fragment-index="0"><code data-trim>
                            $ cd $WORKDIR/lesson1
                            $ cp ../ansible.cfg.sample ansible.cfg
                            $ cat $WORKDIR/lesson1/hosts
                            myserver ansible_host=127.0.0.1 ansible_port=2222
                        </code></pre>
                        <p class="fragment" data-fragment-index="1">
                        You now no longer need to specify an inventory file
                        </p>
                        <pre class="fragment" data-fragment-index="1"><code data-trim>
                            $ ansible myserver -m ping
                        </code></pre>

                    </section>

                <section>
                    <h3>Ansible Modules</h3>
                    <ul>
                        <li class="fragment" data-fragment-index="0">Blob of python that performs a very specific action</li>
                        <li class="fragment" data-fragment-index="1">Ship with Ansible</li>
                        <li class="fragment" data-fragment-index="2">More than
                            200 <a
                                href="https://docs.ansible.com/ansible/latest/list_of_all_modules.html">Ansible
                            modules</a></li>
                        <li class="fragment" data-fragment-index="3">
                            When you run Ansible:
                            <ul>
                                <li>SCP to temporary directory on target host</li>
                                <li>Execute python on target host</li>
                                <li>Returns JSON</li>
                                <li>Code removed from target host</li>
                                <li>Local Ansible evaluates returned JSON</li>
                                <li>Output ok/changed/failed for task based on returned values</li>
                            </ul>
                        </li>

                    </ul>
                </section>

                <section>
                    <h3>
                        Example: The <em>command</em> module
                    </h3>
                    <p style="font-size:16pt;">
                    <code>ansible &lt;host pattern&gt; -m command -a &lt;args to command&gt;</code>
                    </p>
                        
                    <ul>
                        <li class="fragment" data-fragment-index="0">Execute
                            arbitrary command on remote system</li>
                        <li class="fragment" data-fragment-index="1">The default module
                        </li>
                        <li class="fragment" data-fragment-index="2">
                            These are equivalent:
                            <ul>
                                <li><code>ansible myserver -m command -a uptime</code></li>
                                <li><code>ansible myserver -a uptime</code></li>
                            </ul>
                        </li>
                        
                        <li class="fragment" data-fragment-index="3">
                            <a
                               href="https://docs.ansible.com/ansible/latest/command_module.html">Documentation</a>
                        </li>
                    </ul>
                </section>

                <section>
                    <h4>
                        Exercise: Get tail of system messages on your vagrant host
                    </h4>
                    <p>
                    <em>Note</em>: On centos it will be /var/log/messages
                    </p>
                    <pre class="fragment" data-fragment-index="0"><code data-trim>
                        $ ansible myserver  -b -a "tail /var/log/messages"
                    </code></pre>
                </section>
                <section>
                    <h4>Exercise: install a package</h4>
                    <p >
                    Use the <a href="https://docs.ansible.com/ansible/latest/yum_module.html"><em>yum</em></a> module to install <em>mtr</em> (network
                    monitoring tool)
                    </p>
                    <pre class="fragment" data-fragment-index="0"><code data-trim>
                        $ ansible myserver -b -m yum -a "name=mtr state=present"
                    </code></pre>
<asciinema-player class="fragment" data-fragment-index="1"  autoplay="0"  loop="loop" font-size="medium" speed="1"
     theme="solarized-light" src="lib/ansible-install-mtr.json" cols="200" rows="17"></asciinema-player>
                </section>

                <section>
                    <h3>
                        Module documentation
                    </h3>

                    <ul>
                        <li class="fragment" data-fragment-index="0">
                            Places you can find module documentation

                            <ul>
                                <li class="fragment" data-fragment-index="1"><a
                                        href="https://docs.ansible.com/ansible/latest/list_of_all_modules.html">The
                                        ansible community docs</a></li>
                                <li class="fragment" data-fragment-index="2">
                                    Inline documentation

                                </li>
                            </ul>
                        </li>
                    </ul>
                    <pre class="fragment" data-fragment-index="2"><code data-trim>
    $ ansible-doc yum

    &gt; YUM    (~/venv/local/lib/python2.7/site-packages/ansible/modules/packaging/os/yum.py)

            Installs, upgrade, downgrades, removes, and lists packages and groups with the `yum' package manager.

    OPTIONS (= is mandatory):

    - allow_downgrade
            Specify if the named package and version is allowed to downgrade a maybe already installed higher version of that package. Note that setting
            allow_downgrade=True can make this module behave in a non-idempotent way. The task could end up with a set of packages that does not match the complete
            list of specified packages to install (because dependencies between the downgraded package and others can cause changes to the packages which were in
            the earlier transaction).
            (Choices: yes, no)[Default: no]
            version_added: 2.4
                    </code></pre>
                </section>

                <section>
                    <h3>
                        Summary
                    </h3>

                    <ul>
                        <li>
                            This section has given you a small taste of using
                            Ansible in <em>ad hoc</em> mode
                        </li>
                        <li>
                            Interacted with a remote server
                            <ul>
                                <li>Check if SSH works</li>
                                <li>Install OS packages</li>
                                <li>Start services</li>
                            </ul>
                        </li>
                        <li>
                            Explore documetation with <code>ansible-doc</code>
                        </li>
                    </ul>
                </section>
                
                </section>

                <section>
                    <section>
                        
                        <h3>
                            Configuration management with Ansible
                        </h3>
                    </section>
                    <section>
                        <h3>
                            Ansible Playbook
                        </h3>
                        <ul>
                            <li>
                                Run sequences of tasks
                            </li>
                            <li>Primary means of:
                                <ul>
                                    <li>Configuration management</li>
                                    <li>
                                        Deploying applications
                                    </li>
                                    <li>Provisioning</li>
                                    <li>Orchestration</li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    

                    <section>
                        <h3>
                            Working with Ansible Playbooks
                        </h3>
                        
                        <pre><code data-trim>
                            $ cd $WORKDIR/lesson2
                            .
                             ansible
                              files
                               nginx.conf
                              hosts
                              playbook.yml
                              templates
                                  index.html.j2
                             ansible.cfg
                        </code></pre>
                        
                       <table>
                           <tr>
                               <th>Name  </th>
                               <th>Type </th>
                               <th>Description</th>
                           </tr>
                           <tr><td>playbook.yml</td>  <td>file      </td><td>  Ansible Playbook</td></tr>
                           <tr><td>files       </td>  <td>directory </td><td> Contains artefacts to be placed on remote host</td></tr>
                           <tr><td>templates   </td>  <td>directory </td><td>
                                   Contains templates that will be rendered
                                   and uploaded to remote host</td></tr>
                       </table>
                    </section>

                    <section>
                        <h3>
                            Deploy and configure an application
                        </h3>
                        <img src="img/ansible-nginx-install.svg" />
                        <ul>
                        <li>
                            Our Ansible playbook needs to do the following on our
                            Vagrant VM:

                            <ul>
                                <li class="fragment" data-fragment-index="0">Install nginx package</li>
                                <li class="fragment"
                                    data-fragment-index="1">Copy our nginx
                                    config (<code>files/nginx.conf</code>)</li>
                                <li class="fragment"
                                    data-fragment-index="2">Render
                                     template file
                                     (<code>templates/index.html.j2</code>)
                                     and place it on host</li>
                                <li class="fragment" data-fragment-index="3">Re/Start nginx</li>
                            </ul>

                        </li>
                        </ul>
                    </section>
                    

                    
                    <section>
                        <h3>
                            Ansible Playbook Structure
                        </h3>
                        

                        <div style="width:50%;float:left;">
                            <img src="img/playbook-anatomy.svg"/>
                        </div>

                        <div style="width:50%;float:left;">
<ul>
                            <li class="fragment" data-fragment-index="0">
                                A playbook is a YAML file containing a list of
                                <em>plays</em>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                A play is a dictionary object

                                <ul><li>
                                        <code style="color:red;">key</code><code>: </code><code style="color:blue;">value</code>
                                    </li></ul>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Some keys in a play may contain dictionaries or
                                lists
                            </li>
                            
                            
                        </ul>
                        </div>

                        

                    </section>

                    <section>
<h3>
                            Ansible Playbook Structure
                        </h3>
                        <ul>
                            
                            <li class="fragment" data-fragment-index="1">
                                A play must contain following keys:
                                <ul>
                                    <li class="fragment" data-fragment-index="2"><code>hosts</code>
                                        <ul>
                                            <li>
                                                A string
                                            </li>
                                            <li>
                                                These are what you will configure
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="fragment" data-fragment-index="3">tasks
                                        <ul>
                                            <li>
                                                A list of dictionaries
                                            </li>
                                            <li>
                                                What you want to do
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="4">
                                Optionally
                                <ul>
                                    <li>name - description of the play</li>
                                    <li>vars - variables scoped to the play</li>
                                    <li>etc.</li>
                                </ul>
                            </li>
                        </ul></section>
                        <section>
                            <h3>
                                Privilege Escalation
                            </h3>

                            <ul style="width:90%;font-size:18pt;">
                                <li>
                                    Note the <em>become</em> line in <code>playbook.yml</code>
                                    
                                    <pre style="font-size:18pt;"><code
                                    data-trim data-noescape>
    - name: Set up static website with nginx
      hosts: myserver
      <mark >become: true</mark>
      tasks:
                                    </code></pre>
                                </li>
                                <li class="fragment" data-fragment-index="0">
                                    Normally ansible tasks run on a host as an unprivileged user
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Most tasks in our playbook require <em>sudo</em> privileges to run
                                </li>
                                <li class="fragment" data-fragment-index="2">
                                    The <em>become</em> clause:
                                    <ul>
                                        <li class="fragment" data-fragment-index="3">
                                            Tells ansible to run tasks as a certain
                                            user (default sudo)
                                        </li>
                                        <li class="fragment" data-fragment-index="4">
                                            Can be in play or task scope
                                        </li>
                                        <li class="fragment" data-fragment-index="5">
                                            Accepts: <em>true</em> or
                                            <em>yes</em>, <em>false</em> or <em>no</em>
                                        </li>
                                    </ul>
                                </li>
                            </ul>

                        </section>


<section>
                        <h3>
                            Structure of a playbook task
                        </h3>
                        
                        <ul>
                            <li>
                                A task is a dictionary object containing
                                <ul>
                                    <li>name 
                                        <ul>
                                            <li>Describes what the task does</li>
                                            <li>
                                                optional but highly recommended
                                            </li>
                                        </ul></li>
                                        <li>module 
                                            <ul>
                                                <li>
                                                    Dictionary object
                                                </li>
                                                <li>
                                                    Key represents Python
                                                    module which will perform
                                                    tasks
                                                </li>
                                                <li>
                                                    May have arguments
                                                </li>
                                            </ul>

                                        </li>
                                </ul>
                            </li>

                        </ul>
                        
                    </section>
                    <section>
                        <h3>
                            Structure of a playbook task
                        </h3>
                        
                        <div style="width:50%;float:left;">
                            <img src="img/playbook-task-anatomy.svg"/>
                        </div>
                        <div style="width:50%;float:left;">
                            <ul>
                                <li>
                                    Two styles of module object in tasks
                                    <ul>
                                        <li>string form</li>
                                        <li>dictionary form</li>
                                    </ul>
                                </li>
                                <li>
                                    Dictionary form is more suitable for complex
                                    arguments
                                </li>
                                <li>
                                    Matter of
                                    preference/style
                                </li>
                            </ul>


                        </div>


                    </section>
                    
<section>
                        <h3>
                            Run our first playbook
                        </h3>
                        <pre><code data-trim>
                            $ cd $WORKDIR/lesson2
                            $ ansible-playbook ansible/playbook.yml
                        </code></pre>
                        
<asciinema-player  autoplay="0"  loop="loop" font-size="medium" speed="1"
     theme="solarized-light" src="lib/basic-static-site.json" cols="200" rows="15"></asciinema-player>
 <p class="fragment" data-fragment-index="0">
 Visit <a href="http://localhost:8080">static site</a>
 </p>
                    </section>

                    <section>
                        <h3>
                            Summary 
                        </h3>
                        <ul>
                            <li>Use Ansible Playbook to run complex tasks</li>
                            <li>Playbook consists of array of YAML dictionaries called <em>plays</em></li>
                            <li>
                                Each play contains array of tasks that are
                                executed on remote host
                            </li>
                        </ul>

                    </section>

                </section>

                <section>
                    <section>
                        <h2>
                            Ansible Variables
                        </h2>
                    </section>
                    <section>
                        <h3>
                            Ansible Variables
                        </h3>
                        <ul>
                            <li>
                                Several different types:
                                <ul>
                                    <li>inventory variables</li>
                                    <li>play scoped variables</li>
                                    <li>task variables</li>
                                    <li>
                                        extra variables
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    <section>

                        <h3>
                            Inventory Variables
                        </h3>
                        <ul>
                            <li>
                                Are scoped to a host throughout the execution of a playbook
                            </li>
                            <li>
                                Assigned in 
                                <ul>
                                    <li>
                                        the inventory file
                                    </li>
                                    <li>
                                         Subdirectories
                                        <ul>
                                            <li>host_vars/&lt;host&gt;</li>
                                            <li>group_vars/&lt;group&gt;</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                Can be referenced directly when executing play on
                                host
                            </li>
                            <li>
                                Available in <em>hostvars</em> dictionary
                            </li>
                            
                        </ul>
                    </section>
                    <section>
                        <h2>
                            Inventory Variables
                        </h2>

                        <h3>
                            In inventory file
                        </h3>
<pre class="fragment" data-fragment-index="0"><code data-trim>
                                    # assign variable to single host
                                    [web]
                                    web1.mycompany.com ansible_host=152.240.43.12 opt2=arg2
                                    web2.mycompany.com
                                    .
                        </code></pre>
<pre class="fragment" data-fragment-index="1"><code data-trim>
                                    # assign variable to group of hosts

                                    [web]
                                    web1.mycompany.com ansible_host=152.240.43.12
                                    web2.mycompany.com

                                    [web:vars]
                                    proxy=web.mycompany.com

                        </code></pre>
                    </section>


                    

                    <section>
                        <h3>
                            Inventory Variables
                        </h3>
                        <h4>
                            host_vars/&lt;host&gt;
                        </h4>
                        <p>
                        Create a <em>host_vars</em> directory and variable file 
                        </p>
                        <pre style="width:100%;"><code data-trim>
                            $ mkdir $WORKDIR/lesson2/ansible/host_vars
                            $ vim $WORKDIR/lesson2/ansible/host_vars/myserver.yaml
                            # or
                            $ mkdir $WORKDIR/lesson2/ansible/host_vars/myserver
                            $ vim $WORKDIR/lesson2/ansible/host_vars/myserver/vars.yaml
                        </code></pre>
                        <pre style="width:100%;"><code data-trim>
                            # variables for myserver
                            ---
                            foo: bar
                        </code></pre>


                    </section>
                    <section>
                        <h3>
                            Inventory Variables
                        </h3>
                        <h4>
                            group_vars/&lt;group&gt;
                        </h4>
                        <p>
                        Create a <em>group_vars</em> directory and variable file 
                        </p>
                        <pre style="width:100%;"><code data-trim>
                            $ mkdir $WORKDIR/lesson2/ansible/group_vars
                            $ vim $WORKDIR/lesson2/ansible/group_vars/web.yaml
                            # or
                            $ vim $WORKDIR/lesson2/ansible/group_vars/web/vars.yaml
                            </code></pre>
                        <pre style="width:100%;"e><code data-trim>
                            # variables for "web" group
                            ---
                            bizz: buzz
                        </code></pre>

                    </section>
                    <section>
                        <h3>
                            Using Inventory variables
                        </h3>
                        <pre><code data-trim>
                        $ less $WORKDIR/lesson2/ansible/templates/index.html.j2
                        .
                        .
                        {% if foo is defined %}
                        &lt;p&gt;
                        The value for foo is &lt;em&gt;{{ foo }}&lt;/em&gt;
                        &lt;/p&gt;
                        {% endif %}
                        {% if bizz is defined %}
                        &lt;p&gt;
                        The value for bizz is &lt;em&gt;{{ bizz }}&lt;/em&gt;
                        &lt;/p&gt;
                        {% endif %}
                        .
                        .
                        </code></pre>
                        <p>
                        Inventory variables accessed directly in templates
                        </p>
                    </section>

                    <section>
                        <h3>
                            Using Inventory Variables
                        </h3>
                        <pre><code data-trim>
                            $ ansible-playbook ansible/playbook.yaml
                        </code></pre>
                        <ul>
                            <li>Run the ansible-playbook again</li>
                            <li>Note behaviour of <em>Copy up static website html</em> task</li>
                            <li>Reload <a href="http://localhost:8080">website</a>  when finished</li>
                        </ul>
                    </section>
                    <section><h3>
                            hostvars
                        </h3>
                        <ul style="font-size:18pt;width:100%;">
                            <li class="fragment" data-fragment-index="0">
                                Dictionary with                                variables from each host (including inventory variables) </li>
                            <li class="fragment" data-fragment-index="1">
                                    Indexed on hostname from inventory 
                                <ul>
                                    <li><code>hostvars['myserver']['foo'] ==  hostvars.myserver.foo</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Can be accessed across plays in the same playbook run
                            </li>
                            <li class="fragment" data-fragment-index="3">
                                Have a look at <code>playbook-localhost.yml</code>
                            </li>
                            <li class="fragment" data-fragment-index="4">
                                Run <code>playbook.yml</code> and <code>playbook-localhost.yml</code>
                                <pre ><code data-trim>
                                $ ansible-playbook ansible/playbook.yml ansible/playbook-localhost.yml
                                </code></pre>
                                
                            </li>
                            <li class="fragment" data-fragment-index="6">
                                Change <code style="color:red;">foo</code> to
                                <code style="color:red;">hostvars.myserver.foo</code> in
                                <code>playbook-localhost.yml</code> and run
                                playbooks
                            </li>
                            
                        </ul>

                    
                    </section>

                    <section>
                        <h4>
                            Excercise: View a group variable from hostvars
                        </h4>
                        <ul style="width:100%;">
                            <li>
                                The bizz variable still appears as undefined in
                                playbook run
                            </li>
                            <li>
                                How would you find that in hostvars?
                            </li>
                            <li>
                                A group variable will be defined for every
                                host in a group
                                <pre><code data-trim>
                                    - name: Output of bizz
                                      debug:
                                        var: hostvars.myserver.bizz
                                </code></pre>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Play scoped variables
                        </h3>

                        <ul>
                            <li>
                                Declared in control section of a play
                                <ul>
                                    <li>vars - static declaration</li>
                                    <li>vars_prompt - interactively prompt user when running playbook</li>
                                </ul>
                            </li>
                            <li>
                                Can be referenced directly while in play
                            </li>
                            
                        </ul>


                    </section>
                    <section>
                        <h3>
                            Play scoped varibles
                        </h3>
                        <ul style="font-size:18pt;width:100%;">
                            <li class="fragment" data-fragment-index="0">
                                Open <code>playbook.yml</code> in editor
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Edit as shown:

                        <pre style="font-size:18pt;" ><code data-trim
                        data-noescape>
    - name: Set up static website with nginx
      hosts: myserver
      become: true
      <mark>
      vars_prompt:
        - name: "participant_name"
          prompt: "What is your name"
          private: no
      vars:
        course: Introduction to ansible
        lesson:
          name: Working with play variables
          session: 1</mark>

      tasks:
      .
      .

                        </code></pre>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Rerun ansible-playbook
                            </li>
                        </ul>
                        


                    </section>

                    <section>
                        <h3>
                            Task Variables
                        </h3>
                        <ul>
                            <li>Contain data discovered while executing a task</li>
                            <li>Gathering facts phase of play execution</li>
                            <li>
                                Tasks that gather user input
                            </li>
                            <li>Become part of the host scope once defined</li>
                            <li>In a play they can be directly referenced</li>
                            <li>In subsequent plays are available in hostvars dictionary for host</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>
                            Assigning task variables
                        </h3>
                        <h4>
                            Using the <code>set_fact</code> module
                        </h4>
                        

                        <pre><code data-trim>
                        tasks:
                          - name: Assign an arbitrary variable
                            set_fact:
                              person_name: Homer Simpson

                          - name: Assign dictionary
                            set_fact:
                              person_details:
                                street: 754 Evergreen Terrace
                                city: Springfield
                                state: ST
                        </code></pre>
                    </section>
                    <section>
                        <h3>
                            Assigning task variables
                        </h3>
                        <h4>
                            Capturing output with <em>register</em> attribute
                        </h4>

                        <pre><code data-trim>
                            - name: Execute code and capture the output
                              command: uptime
                              register: uptime_output

                              .
                              .
                            - name: do something with output of uptime
                              debug:
                                var: {{ uptime_output.stdout }}
                        </code></pre>
                    </section>

                    <section>
                        <h4>
                            Exercise: Assign some task variables
                        </h4>
<pre class="fragment" data-fragment-index="0"><code data-trim>
    tasks:
        - name: set name of person
          set_fact:
            person_name: Homer Simpson

        - name: Get output of uptime
          command: uptime
          register: uptime_output
        .
        .
                        </code></pre>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Use <code>set_fact</code> and
                                <code>register</code> in playbook.yml to assign task variables
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Rerun ansible playbook
                            </li>
                        </ul>

                        

                    </section>

                    <section>
                        <h3>
                            Gathering facts
                        </h3>
                        <ul>
                            <li>
                                Plugin run  before play executes
                                <ul>
                                    <li>
                                        <code>setup</code> module
                                    </li>
                                </ul>
                            </li>
                            <li>
                                Collects detailed information about host and attaches to host scope
                            </li>
                            <li>
                                You can get an idea by running
                                <ul>
                                    <li>
                                        <code> ansible myserver -m setup </code>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                Filter facts to find variables you are
                                interested in:
                                <ul>
                                    <li>
                                        <code style="font-size:15pt;">
                                            ansible myserver -m setup -a 'filter=ansible_distribution*'
                                        </code>
                                    </li>
                                </ul>
                            </li>
                        </ul>

                    </section>

                    <section>
                        <h3>
                            Exercise: Display system facts
                        </h3>

                        <p>
                        Uncomment area in <code>templates/index.html.j2</code>
                        </p>


                        <pre><code data-trim>
        &lt;!--   remove line
        {% if ansible_distribution is defined %}
            &lt;p&gt;  
            System facts: {{ ansible_distribution }} {{ ansible_distribution_major_version }} {{ ansible_architecture }}
            &lt;/p&gt;
        {% endif %}
        --&gt;   remove line
                        </code></pre>
                        <p class="fragment" data-fragment-index="0">
                        Re-run ansible-playbook and visit <a href="http://localhost:8080">static website</a>
                        </p>
                    </section>

                    <section>
                        <h3>
                            Exercise: Turn off gather facts
                        </h3>
                        <p>
                        Edit playbook.yml as follows
                        </p>

                        <pre><code data-trim>
                            - name: Set up static website with nginx
                              hosts: myserver
                              become: true
                              gather_facts: false   # &lt;-- add this line
                              tasks:
                                .
                                .
                        </code></pre>
<p class="fragment" data-fragment-index="0">
                        Re-run ansible-playbook and visit <a href="http://localhost:8080">static website</a>
                        </p>
                    </section>

                    <section>
                        <h3>
                            Extra variables
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Variables passed to ansible or
                                ansible-playbook via
                                command line
                            <ul>
                                <li class="fragment"
                                    data-fragment-index="1"><code
                                        style="font-size:15pt;">ansible-playbook
                                        --extra-vars="key1=value1 key2=value2"
                                playbook.yml</code></li>
                                <li class="fragment"
                                    data-fragment-index="2"><code
                                    style="font-size:15pt;">ansible-playbook
                                    -e key1=value1 -e key2=value2 playbook.yml</code></li>
                                <li class="fragment"
                                    data-fragment-index="3"><code
                                        style="font-size:15pt;">ansible-playbook
                                        -e @extra-variables.yml playbook.yml</code></li>
                            </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Variable precedence
                        </h3>
                        <ul><li>
                                Ansible variables in order of increasing
                                precedence:
                                <ul>
                                    <li>inventory file</li>
                                    <li>host facts</li>
                                    <li>play vars_files</li>
                                    <li>task vars</li>
                                    <li>include_vars</li>
                                    <li>set_facts/registered variables</li>
                                    <li>extra vars</li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="0">
                            <a
                                href="https://docs.ansible.com/ansible/latest/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">complete
                                list</a>
                            </li>
                        </ul>

                    </section>
                    <section>
                        <h3>
                            Exercise: variable precedence
                        </h3>
                        <p>
                        Pass extra vars to ansible playbook to override
                        previous examples
                        </p>

                        <pre><code data-trim>
                        $ ansible-playbook ansible/playbook.yml \
                           -e person_name="Marge Simpson" \
                           -e '{"lesson": {"name": "Override variables", \
                           "session": 2}}'
                        </code></pre>
                    </section>
                    
                    <section>
                        <h3>
                            Summary
                        </h3>
                        <ul><li>
                                There are several types of variables in Ansible
                                <ul>
                                    <li>inventory</li>
                                    <li>play scoped</li>
                                    <li>task variables</li>
                                    <li>extra </li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                </section>

                <section>
                    <section>
                        <h2>
                            Templating in Ansible
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Templating in Ansible
                        </h3>
                        <ul>
                            <li>
                                Sometimes you need dynamic behaviour in plays/tasks
                                <ul>
                                    <li>File locations</li>
                                    <li>Fill in prompted information</li>
                                    <li>
                                        secret info (passwords, API keys)
                                    </li>
                                    <li>Generally sourced from a variable</li>
                                </ul>
                            </li>
                            <li>
                                Ansible uses a template syntax called Jinja2
                            </li>
                        </ul></section>

                        <section>
                            <h3>
                                Jinja2
                            </h3>
                            <h5>
                                A very very brief intro
                            </h5>


                            <ul>
                                
                                <li>
                                    Provides tools for
                                    <ul>
                                        <li>passing variables</li>
                                        <li>evaluating expressions</li>
                                        <li>filters</li>
                                        <li>etc.</li>
                                    </ul>
                                </li>
                                <li>
                                    References
                                    <ul>
                                        <li><a href="https://docs.ansible.com/ansible/latest/playbooks_templating.html">Templating in Ansible</a></li>
                                        <li><a href="http://jinja.pocoo.org/docs/2.10/templates/">Jinja2 official docs</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </section>
                        <section>
                            <h3>
                                Basic Jinja2
                            </h3>
                            <h5>
                                Variables
                            </h5>
                            <ul>
                                <li>
                                    Simple variables or expressions
                                    <ul>
                                        <li>
                                            <code style="font-size:15pt;">{{ person_name  }}</code> 
                                        </li>
                                        <li>
                                            <code style="font-size:15pt;">{{ 1 + 1 }}</code> 
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    Dictionaries
                                    <ul>
                                        <li><code style="font-size:15pt;">{{ lesson['name'] }}</code></li>
                                        <li><code style="font-size:15pt;">{{ lesson.name }}</code></li>
                                        <li><code style="font-size:15pt;">{{ hostvars['myserver'].ansible_distribution }}</code></li>
                                    </ul>
                                </li>

                            </ul>

                        </section>

                        <section>
                            <h4>
                                Exercise: Templating in our playbook
                            </h4>
                            <ul>
                                <li>
                                    Edit <code>vars</code> section in <code>playbook.yml</code> to add:
                                    <ul>
                                        <li><code style="font-size:15pt;">static_file_directory</code></li>
                                        <li><code style="font-size:15pt;">nginx_conf_directory</code></li>
                                    </ul>
                                </li>
                            </ul>

                            <pre><code data-trim>
                                vars:
                                  .
                                  static_file_directory: /usr/share/nginx/html
                                  nginx_conf_directory: /etc/nginx/conf.d 
                                tasks:
                            </code></pre>
                        </section>

                        
                        <section>
                            <h4>
                                Exercise: Templating in our playbook
                            </h4>
                            <ul>
                                <li>
                                    Use template syntax to replace path for
                                    <ul>
                                        <li>nginx</li>
                                        <li>index.html</li>
                                    </ul>
                                </li>
                            </ul>

                            <pre class="fragment" data-fragment-index="0"><code data-trim>
        - name: Copy in nginx config file
          copy:
            .
            dest: "{{ nginx_conf_directory }}/nginx.conf"
            .

        - name: Copy up static website html
          template:
            .
            dest: "{{ static_file_directory }}/index.html"
            .
                            </code></pre>
                            <p class="fragment" data-fragment-index="1">
                            Re-run the ansible playbook
                            </p>
                        </section>
                        <section>
                            <h3>
                                Templates and Quoting
                            </h3>
                            <ul style="width:80%;">
                                <li>
                                    Be aware that you will often need to put quotes
                                    around values when using templates
                                    <pre><code data-trim>
                                        dest: "{{ nginx_conf_directory }}/nginx.conf"
                                    </code></pre>
                                </li>
                                <li>
                                    However sometimes you do not need them
                                    <pre><code data-trim>
                                        command: ls {{ nginx_conf_directory }
                                    </code></pre>

                                </li>
                            </ul>
                        </section>

                </section>
                <section>
                    <section>
                        <h2>
                            Iteration and Conditionals in Ansible
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Iteration and Conditionals in Ansible
                        </h3>
                        <pre><code data-trim>
                            $ cd $WORKDIR/lesson3
                            $ tree
                            .
                             ansible
                              hosts
                              playbook-dict.yml
                              playbook-lists.yml
                             ansible.cfg
                        </code></pre>
                    </section>

                        <section>
                            <h2>
                                Iterating through lists
                            </h2>
                        </section>
                        <section>
                            <h3>
                                Iterating through lists
                            </h3>
                            <h4>
                                <code>with_items</code>
                            </h4>
                            <ul>
                                <li>Step through an array</li>
                                <li>Each element is assigned to variable <em>item</em></li>
                            </ul>
                            <pre><code data-trim>
                                - name: Process a list of items
                                  copy:
                                    src: "/path/to/local/{{ item }}"
                                    dest: "/path/to/remote/{{ item }}"
                                  with_items: "{{ list_of_files }}"
                            </code></pre>

                        </section>
                        <section>
                            <h3>
                                Configuring our fake application <em>myapp</em>
                            </h3>
                            
                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    Have a look at <code>ansible/playbook-lists.yml</code>
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Run the playbook and then have a look in
                                    /etc/myapp/config
                                </li>

                                <li class="fragment" data-fragment-index="2">
                                    It adds lines to a configuration file for a fake
                                    app
                                </li>
                                <li class="fragment" data-fragment-index="3">
                                    There are a number of things we can optimise
                                </li>
                            </ul>
                        </section>
                        <section>
                            <h4>
                                Exercise: Remove repetitive allowed_host(s) tasks from playbook
                            </h4>
                            <ul>
                                <li>
                                    Use <code>with_items</code> to simplify allowed_host tasks
                                </li>
                                <li class="fragment" data-fragment-index="0">
                                    Replace all the allowed host tasks with:
                                </li>
                            </ul>

                            <pre class="fragment" data-fragment-index="0"><code data-trim>
        - name: Add allowed_hosts entries
          lineinfile:
            path: /etc/myapp/config
            line: "allow_from: {{ item }}"
            insertafter: EOF
          with_items:
            - "{{ allowed_host1 }}"
            - "{{ allowed_host2 }}"
            - "{{ allowed_host3 }}"

                            </code></pre>

                        </section>
                        <section>
                            <h4>
                                Exercise: Remove repetitive listen tasks from playbook
                            </h4>
                            <ul>
                                <li>
                                    Use <code>with_items</code> to simplify listen tasks
                                </li>
                                <li class="fragment" data-fragment-index="0">
                                    Replace all the listen tasks with:
                                </li>
                            </ul>

                            <pre class="fragment" data-fragment-index="0"><code data-trim>

    - name: Add listen port entries
      lineinfile:
        path: /etc/myapp/config
        line: "listen: {{ item }}"
        insertafter: EOF
      with_items: "{{ listen_ports }}"
                            </code></pre>

                        </section>
                        <section>
                            <h3>
                                Nesting Loops
                            </h3>
                            <h4>
                                <code>with_nested</code>
                            </h4>
                            <ul style="width:100%;"><li>
                                    It is also possible to loop over two lists at once
                                    

                                </li></ul>
<pre><code data-trim>
                                    - name: Add allowed ports for each host
                                      lineinfile:
                                        path: /etc/myapp/config
                                        line: "host: {{ item[0] }}:{{ item[1] }}"
                                        insertafter: EOF
                                      with_nested:
                                        - [ "{{ allowed_host1 }}", "{{ allowed_host2 }}", "{{ allowed_host3 }}"]
                                        - "{{ listen_ports }}"
                                    </code></pre>


                        </section>

                        <section>
                            <h2>
                                Iterating through dictionaries
                            </h2>
                        </section>
                    
                        <section>
                            <h3>
                                Iterating through dictionaries
                            </h3>
                            <h4><code>with_dict</code></h4>
                            <ul>
                                <li>
                                    Takes a dictionary as argument
                                </li>
                                <li>
                                    Each item has
                                    <ul>
                                        <li>key</li>
                                        <li>value</li>
                                    </ul>
                                </li>
                            </ul>
                            <pre><code data-trim>
                                - name: Task that iterates over a dictionary
                                  somemodule:
                                    arg: "{{ item.key }}"
                                    arg2: "{{ item.value }}"
                                  with_dict: "{{ dictionary }}"
                            </code></pre>
                        </section>

                        <section><h3>
                                More configuration for myapp
                            </h3>
                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    <code>ansible/playbook-dict.yml</code> sets up
                                    database config for fake application
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Adds each element of <em>database</em>
                                    variable to config
                                </li>

                                <li class="fragment" data-fragment-index="2">
                                    Run the playbook and have a look at
                                    /etc/myapp/app_config 
                                </li>
                            </ul>

                        </section>

                        <section>
                            <h4>
                                Exercise: Remove repetition from playbook-dict.yml
                            </h4>
                            <ul>
                                
                                <li >
                                    Refactor playbook using <code>with_dict</code> to
                                    remove repetitive tasks.
                                </li>
                            </ul>
                            <pre class="fragment" data-fragment-index="0"><code data-trim>
                                - name: Add database config to /etc/myapp/config
                                  lineinfile:
                                    path: /etc/myapp/app_config
                                    line: "database_{{ item.key }}={{ item.value }}"
                                  with_dict: "{{ database[env_name] }}"
                            </code></pre>

                        </section>

                        <section>
                            <h2>
                                Conditionals
                            </h2>
                        </section>


                        <section>
                            <h3>
                                The <em>when</em> statement
                            </h3>

                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    The main way to conditionally do something in
                                    Ansible is to use the <em>when</em> statement
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Identical semantics to a Python <em>if</em> block
                                    <ul>
                                        <li class="fragment" data-fragment-index="2">
                                            <code>when: some_variable is defined</code>
                                        </li>
                                        <li class="fragment" data-fragment-index="2">
                                            <code>when: env_name == 'staging'</code>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                            <pre class="fragment" data-fragment-index="4"><code data-trim>
                                - name: Some task
                                  command: do something
                                  when: &lt;condition is true&gt;
                            </code></pre>
                        </section>
                        
                        <section>
                            <h4>
                                Exercise: Make our tasks conditional 
                            </h4>
                            <ul>

                            <li>
                                Tasks in <code>ansible/playbook-dict.yml</code> assume a staging environment
                            </li>
                                <li>Add conditional to <code>lineinfile</code> task</li>
                                <li>Only execute if <code>env_name</code> is <em>production</em></li>
                                <li>
                                    re run the playbook
                                </li>
                            </ul>
                            
                            <pre  class="fragment" data-fragment-index="0"><code data-trim>
                                    - name: Add database config to /etc/myapp/config
                                      lineinfile:
                                      .
                                      .
                                      when: env_name == 'production'
                            </code></pre>


                        </section>
                        <section>
                            <h4>
                                Exercise: Override default <em>env_name</em> to run tasks
                            </h4>
                            <ul>
                                <li><em>env_name</em> is set to <em>staging</em> by default in vars section</li>
                                <li>Override this to be <em>production</em> and re-run playbook</li>
                                <li>Hint: What type of variable has precedence?</li>
                            </ul>
                            <pre  class="fragment" data-fragment-index="0"><code data-trim>
                                $ ansible-playbook ansible/playbook-dict.yml -K \
                                     -e env_name=production
                            </code></pre>
                        </section>
                        
                </section>

                <section>
                    <section>
                        <h2>Protecting Secrets in Ansible</h2>
                    </section>
                    <section>
                        <h3>
                            Protecting secrets in Ansible
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">One problem with playbook-dict.yml</li>
                            <li class="fragment" data-fragment-index="1">Database passwords are out in the open</li>
                            <li class="fragment" data-fragment-index="2">Ansible provides a built in tool for managing secrets</li>
                            <li class="fragment" data-fragment-index="3">
                                <code>ansible-vault</code> helps you
                                encrypt/decrypt files containing secrets for
                                your app
                            </li>
                        </ul>
                        <pre class="fragment" data-fragment-index="4"><code data-trim>
                            $ ansible-vault --help

                            Usage: ansible-vault [create|decrypt|edit|encrypt|encrypt_string|rekey|view] [options] [vaultfile.yml]

                            encryption/decryption utility for Ansible data files

                            Options:
                            --ask-vault-pass      ask for vault password
                            -h, --help            show this help message and exit
                        </code></pre>
                    </section>
                    <section>
                        <h3>
                            About Ansible Vault
                        </h3>
                        <ul>
                            <li>
                                Uses AES256 encryption
                            </li>
                            <li>
                                Secret files can be 
                                <ul>
                                    <li>Loaded automatically as <code>host_vars</code> or <code>group_vars</code> inventory files</li>
                                    <li>included <em>include_vars</em> or <em>vars_files</em></li>
                                </ul>
                            </li>
                            <li>
                                Encrypted files can be distributed with your
                                application
                            </li>
                        </ul>
                        
                    </section>
                    <section>
                        <h3>
                            Protecting our database passwords
                        </h3>
                        <ul style="width:90%;">
                            <li>
                                Create a new yml file:
                                <pre><code data-trim>
                                  $ $EDITOR $WORKDIR/lesson3/ansible/secrets.yml
                                    ---
                                    vault_staging_database_password: &lt;some password&gt;
                                    vault_production_database_password: &lt;some password&gt;
                                </code></pre>

                            </li>
                            <li>
                                Encrypt ansible/secrets.yml.
                                <pre><code data-trim>
                                    $ ansible-vault encrypt ansible/secrets.yml
                                    New Vault password: 
                                    Confirm New Vault password: 
                                    Encryption successful
                                </code></pre>
                                <ul>
                                    <li>
                                        Make sure you remember your password!
                                    </li>
                                </ul>
                            </li>
                            
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Integrating vaulted secrets
                        </h3>
                        <ul style="font-size:18pt;">
                            <li>
                                Import <code>secrets.yml</code> using vars_files
                                <pre style="font-size:18pt;"><code data-trim>
                                    vars_files:
                                      - secrets.yml
                                </code></pre>
                            </li>
                            <li>
                                Replace references to staging/production database
                                passwords
                                <pre style="font-size:18pt;"><code data-trim>
                                    database:
                                      staging:
                                        .
                                        password: "{{ vault_staging_database_password }}"
                                      production:
                                        .
                                        password: "{{ vault_production_database_password }}"
                                </code></pre>
                            </li>
                            <li>
                                Run playbook using <code style="color:red;">--ask-vault-pass</code> flag
                            </li>
                        </ul>
                    </section>

                    <section>
                        <h3>
                            vault password file
                        </h3>
                        <ul>
                            <li class="fragment"
                                data-fragment-class="0">Typing the vault
                                password all the time gets annoying</li>
                            <li class="fragment" data-fragment-class="1">Fortunately there's a workaround</li>
                            <li class="fragment" data-fragment-class="2">You
                                can put your vault password in a file and
                                reference it with the option <ul><li><code>--vault-password-file &lt;path&gt;</code></li></ul>
                            </li>
                            <li class="fragment" data-fragment-class="3">
                                Conventionally called <code>.vault_password</code>
                                <pre><code data-trim>
                                    $ echo "mysecretpassword" &gt; ansible/.vault_password
                                </code></pre>
                            </li>
                            <li class="fragment" data-fragment-class="4">
                                Be sure you add this to <code>.gitignore</code>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Summary
                        </h3>
                        <ul>
                            <li>
                               <code>ansible-vault</code> is a way to keep secrets safe
                                <ul>
                                    <li>passwords</li>
                                    <li>API keys</li>
                                    <li>SSL keys</li>
                                </ul>
                            </li>
                            <li>Can distribute encrypted secrets with your code</li>
                            <li>Automatically integrate into automation tasks</li>
                        </ul>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>
                            Filters
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Filters
                        </h3>
                        <pre><code data-trim>
                            $ cd $WORKDIR/lesson4
                            $ tree

                             ansible
                              hosts
                              playbook-formatting.yml
                              playbook-list.yml
                              undefined.yml
                             ansible.cfg
                        </code></pre>
                    </section>
                    

                    <section>
                        <h3>
                            Filters
                        </h3>
                        <ul>
                            <li>
                                Subset of functionality provided by Jinja2
                            </li>
                            <li>
                                Toolset for
                                <ul>
                                    <li>formatting data</li>
                                    <li>iteration</li>
                                    <li>filtering</li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    <section>
                        <h3>
                            Using filters
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Filter syntax is 
                                <ul>
                                    <li class="fragment"
                                        data-fragment-index="1"><code
                                            style="color:blue;">variable</code><code
                                            style="color:red;"> | </code><code style="color:blue;">filtername</code></li>
                                    <li  class="fragment" data-fragment-index="2">
                                        <code>variable</code> contains data of
                                        some kind
                                    </li>
                                    <li  class="fragment" data-fragment-index="3">
                                        The "<code>|</code>" is the <em>pipe</em> symbol
                                    </li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="4">
                                Filters will <em>usually</em> be used within Jinja2 expression syntax
                                <ul>
                                    <li class="fragment" data-fragment-index="5">
                                        <code
                                            style="color:green;">{{</code><code
                                            style="color:blue;">  data </code><code> | </code><code style="color:blue;">filter</code><code style="color:green;"> }}</code> 
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    <section>
                        <h3>
                            Formatting Data
                        </h3>
                        <h4> <code>to_yaml</code> &amp; <code>to_json</code> </h4>
                        <ul>
                            <li class="fragment" data-fragment-index="0">Output data in <em>yaml</em> or <em>json</em> format</li>
                            <li class="fragment" data-fragment-index="1">Can be used to generate config files that are consumed by applications</li>
                            <li class="fragment" data-fragment-index="2">
                                Variants for making output <em>prettier</em>
                                <ul>
                                    <li>to_nice_yaml</li>
                                    <li>to_nice_json</li>
                                </ul>
                            </li>
                        </ul>

                    </section>
                    <section>
                        <h4>
                            Exercise: Output myfirstapp to a yaml formatted file
                        </h4>

                        <ul class="stretch">
                            <li class="fragment" data-fragment-index="0">
                                Add the following task to <code>playbook-formatting.yml</code>
<pre class="fragment" data-fragment-index="1"><code data-trim>
        - name: Output myfirstapp as yaml config
          copy:
            dest: /home/train/myfirstapp.yml
            content: "{{ myfirstapp | to_nice_yaml  }}"
            owner: train
            group: train
            mode: 0644
                        </code></pre>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Run the playbook
                                <ul>
                                    <li>
                                        <code>ansible-playbook ansible/playbook-formatting.yml</code>
                                    </li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="3">
                                Try using <code>to_nice_yaml</code> and play with the indentation
                            </li>
                        </ul>
                        
                    </section>
                    <section>
                        <h3>
                            Dealing with undefined variables
                        </h3>
                        <ul>
                            <li>
                                How to deal with undefined variables?
                            </li>
                            <li class="fragment" data-fragment-index="0">
                                Force failure
                                <ul>
                                    <li>mandatory</li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Provide a default
                                <ul>
                                    <li>default</li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="3">
                                Omit them if not needed
                            </li>
                        </ul>
                           

                    </section>
                    <section>
                        <h3>
                            Making variables mandatory
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">Run
                                playbook <code>undefined.yml</code></li>
                            <li class="fragment" data-fragment-index="2">
                                The mandatory filter causes playbook to crash as
                                soon as it attempts to access variable
                            </li>
                            <li class="fragment" data-fragment-index="3">After it crashes, run it again with <em>someport</em> defined using an
                                extra variable</li>
                            <li class="fragment" data-fragment-index="4">
                                Using <code>mandatory</code> filter not generally necessary
                                because ansible will crash anyway if it encounters
                                an undefined variable in a template
                            </li>
                        </ul>

                    </section>

                    <section>
                        <h3>
                            Setting default values
                        </h3>
                        <ul class="stretch">
                            <li class="fragment" data-fragment-index="0">
                                Note value of db_port in playbook output

                                <pre><code data-trim>
        TASK [Output value of a variable that hasn't been defined] ****
        ok: [localhost] => {
            "db_port": "3306"
        }
                                </code></pre>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Using <code>default</code> filter to set arbitrary value
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                A better approach to handling undefined variables
                                than <code>mandatory</code>
                            </li>
                            <li class="fragment" data-fragment-index="3">
                                Run playbook with <code>someport2=5432</code> as an extra variable
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Filtering Lists
                        </h3>

                        <dl>
                            <dt>union    </dt><dd> Get union of two lists</dd>
                            <dt>intersect</dt><dd>  Get interstion of two lists</dd>
                            <dt>unique   </dt><dd> Get a set of unique items</dd>
                        </dl>

                    </section>

                    <section>
                        <h3>
                            Processing lists
                        </h3>
                        <ul class="stretch">
                            <li>
                                The map filter is useful for processing lists
                            </li>
                            <li>
                                Useful when chained to other filters
                            </li>
                            <li>
                                In playbook-list.yml add the following:

                                <pre style="font-size:12pt;"><code data-trim>
                security_group_names: "{{ security_groups | map(attribute='name') | unique | list }}"
                                </code></pre>
                            </li>
                        </ul>
                       


                    </section>
                    <section><h3>
                            Extracting from containers
                        </h3>
                        <h4>
                            <code>map 'extract'</code>
                        </h4>
                        <ul class="stretch">
                            <li>
                                We can get data using the <code>map extract</code> filter:

                                <ul style="font-size:18pt;">
                                    <li><code>{{ [0,2] | map('extract', list1) | list }}</code></li>
                                    <li><code>{{ ['day', 'year'] | map('extract', dict1) | list }}</code></li>
                                </ul>
                            </li>
                            <li >
                                Add these to the vars section and add debug
                                tasks to display them
                            </li>
                        </ul>

                    
                    </section>
                    <section>
                        <h3>
                            Processing IP addresses
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Can be used to test validity of IP addresses
                                <ul>
                                    <li class="fragment"
                                        data-fragment-index="1"><code>'192.168.1.1'
                                            | ipaddr</code><code class="fragment" data-fragment-index="2" style="color:green"> => '192.168.1.1'</code></li>
                                    <li class="fragment"
                                        data-fragment-index="3"><code>'192.168.25.1.25'
                                            | ipaddr</code><code
                                        class="fragment"
                                        data-fragment-index="4"
                                        style="color:red"> => false</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="5">
                                Can handle specific protocol version
                                <ul>
                                    <li><code>myipv4 | ipv4</code></li>
                                    <li><code>myipv6 | ipv6</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="6">
                                Can also extract IP addresses from CIDR notation

                                <ul style="font-size:20pt;">
                                    <li><code>'10.14.33.0/24' |
                                            ipaddr('address')</code><code class="fragment" data-fragment-index="7" style="color:green;"> => '10.14.33.0</code></li>
                                </ul>
                            </li>

                        </ul>

                    </section>

                    <section>
                        <h3>
                            Processing filesystem paths
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Get the base file name from a path
                                <ul>
                                    <li class="fragment" data-fragment-index="1"><code>'/home/train/somefile.txt' | basename</code> </li>
                                    <li class="fragment" data-fragment-index="2">returns <code>somefile.txt</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="3">
                                Alternatively, get the directory path
                                <ul>
                                    <li class="fragment" data-fragment-index="4"><code>'/home/train/somefile.txt' | dirname</code> </li>
                                    <li class="fragment" data-fragment-index="5">returns <code>/home/train</code></li>
                                </ul>
                            </li>
                        </ul>


                    </section>



                        <section>
                            <h3>Summary</h3>

                            <ul>
                                <li>Let's just look at the <a href="https://docs.ansible.com/ansible/latest/playbooks_filters.html">offical documentation</a></li>
                            </ul>
                        </section>

                    

                </section>

                <!--<section>
                <section>
                    <h3>Continuous integration</h3>
                    <ul>
                        <li>Trunk based development</li>
                        <li>Every developer commit triggers a merge/build/test cycle</li>
                        <li>Automated testing</li>
                    </ul>
                </section>
                <section>
                    <h3>Continuous delivery/deployment</h3>
                    <ul>
                        <li>Automated Pipeline from developer commit to production deploy</li>
                        <li>Requires lots of automated tests</li>
                        <li>Deploying more frequently lowers risk</li>
                    </ul>
                </section>
                <section>
                    <h3>Continuous delivery antipatterns</h3>
                    <ul>
                        <li>Deploying software manually</li>
                        <li>Manual configuration of production environments</li>
                        <li>Deploying to a production-like environment only after development is complete</li>
                    </ul>
                </section>
                <section class="image-slide">
                    <h2>DevOps</h2>
                    <img src="img/picture1_1.png" alt="DevOps" height="496" width="634">
                </section>
                <section class="image-slide">
                    <h2>DevOps</h2>
                    <img src="img/devops-common-use-cases-architectures-best-practices-22-638.jpg" alt="DevOps" height="359" width="638">
                </section>
                <section>
                    <h3>Microservices</h3>
                    <ul>
                        <li>Each microservice needs a full dev to prod pipeline</li>
                        <li>You have N microservices</li>
                        <li>Automation is the only reasonable way to achieve this</li>
                    </ul>
                </section>
                [> Large image slide <]
                <section class="image-slide">
                    <h2>Netflix Microservices</h2>
                    <img src="img/netflix-microservices.jpg" alt="Netflix Microservices" height="600" width="800">
                </section>

                </section>-->
                <section>
                    <section>
                        <h2>
                            Infrastructure as Code
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Infrastructure as Code
                        </h3>
                        
                        <pre><code data-trim>
                            $ cd $WORKDIR/lesson5
                            $ tree
                            .
                             ansible
                            .
                            .
                             templates
                              index.html
                             wsgi.py

                        </code></pre>
                        <ul>
                            <li>lesson5 directory is set up as a complete application</li>
                            <li>Infrastructure <em>code</em> in one repo with application code</li>
                        </ul>
                    </section>
                <section>
                    <h3>Immutable Infrastructure</h3>
                    <ul>
                        <li><a href="https://blog.engineyard.com/2014/pets-vs-cattle">Cattle vs pets</a></li>
                        <li><a href="http://martinfowler.com/bliki/SnowflakeServer.html">Snowflake Servers</a> vs. <a href="http://martinfowler.com/bliki/PhoenixServer.html">Phoenix Servers</a></li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Cattle vs Pets</h2>
                    <img src="img/servers_pets_or_cattle.jpg" alt="Cattle vs Pets" height="600" width="800">
                </section>
                <section>
                    <h3>Immutable Infrastructure</h3>
                    <ul>
                        <li>The environment is defined in code (Infrastructure as Code)</li>
                        <li>If you need to change <em>anything</em> you create a new instance and destroy the old one</li>
                        <li>Stop Configuration Drift</li>
                        <li>Practice failure and iterate</li>
                        <li>Declarative</li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Immutable Infrastructure</h2>
                    <img src="img/immutable_infrastructure.gif" alt="Immutable Infrastructure" height="600" width="800">
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Blue-green deployments</h2>
                    <img src="img/blue_green_deployments.png" alt="Blue / Green Deployments" height="600" width="800">
                    <aside class="notes" >
                        Blue-green deployment is a technique that reduces downtime and risk by running two identical production environments called Blue and Green. At any time, only one of the environments is live, with the live environment serving all production traffic. For this example, Blue is currently live and Green is idle.
                    </aside>
                </section>


                </section>





                
                <!--<section>
                    <h3>Idempotence Revisited</h3>
                    <ul>
                        <li>Make the same request repeatedly to produce the same result</li>
                        <li>ok = I checked and the thing you wanted was already done so I skipped doing it</li>
                        <li>changed = I checked and the thing you wanted was not done so I did it</li>
                    </ul>
                    <pre><code data-trim contenteditable>
PLAY RECAP *********************************************************************
localhost                  : ok=6    changed=4    unreachable=0    failed=0

...

PLAY RECAP *********************************************************************
localhost                  : ok=6    changed=0    unreachable=0    failed=0
                    </code></pre>
                </section>-->

                
                

                

                

                <section>

                    <section>
                        <h3>
                            Catalyst Cloud
                        </h3>
                    </section>

                    <section>
                        <h3>
                            Provisioning Machines
                        </h3>
                        <p>
                        Let's provision 3 machines:
                        </p>
                        <dl>
                            <dt>App server</dt>
                            <dd>Runs a basic Flask (Python) app</dd>
                            <dt>DB server</dt>
                            <dd>Dedicated postgresql database</dd>
                            <dt>Web server</dt>
                            <dd>Nginx proxy requests to app server</dd>
                        </dl>
                    </section>
                    
                    <section>
                        <h3>
                            The provisioning playbook
                        </h3>

                        <ul>
                            <li>
                                <code>ansible/provision-hosts.yml</code>
                            </li>
                            <li>
                                This playbook does quite a lot
                                <ul>
                                    <li>creates networks/subnets in Catalyst Cloud</li>
                                    <li>creates security groups to control access</li>
                                    <li>sets up routers</li>
                                    <li>creates servers</li>
                                </ul>
                            </li>
                            <li>
                                Not going to focus on this, just run the playbook
                                <pre><code data-trim>
    $ ansible-playbook -i ansible/cloud-hosts \
        ansible/provision-hosts.yml \
        -K -e suffix=-$(hostname) --ask-vault-pass
                                </code></pre>
                            </li>
                        </ul>


                    </section>

                    <section>
                        <h4>
                            Exercise: check that hosts are running and reachable
                        </h4>
                        <ul>
                            <li>
                                Use a tool that you have learned to verify that 
                                all your hosts can be reached by SSH
                            </li>
                        </ul>
                        <pre class="fragment" data-fragment-index="0"><code data-trim>
                            $ ansible -i ansible/cloud-hosts mycluster -m ping
                        </code></pre>
                    </section>
                    <section>
                        <h3>
                            Deploying an application
                        </h3>
                        <ul style="font-size:18pt;">
                            <li>
                                <code>ansible/deploy-app.yml</code> sets up:
                            </li>
                            <li>
                                the db server
                                <ul>
                                    <li>Installs postgresql</li>
                                    <li>Sets up a db</li>
                                </ul>
                            </li>

                            <li>
                                the app server
                                <ul>
                                    <li>Installs a Python virtualenvironment</li>
                                    <li>Sets up wsgi and gunicorn</li>
                                </ul>
                            </li>

                            <li>
                                the web sever
                                <ul>
                                    <li>Installs nginx</li>
                                    <li>proxy requests to app server</li>
                                </ul>
                            </li>
                
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Deploy our application
                        </h3>

                        <pre><code data-trim>
    $ ansible-playbook -i ansible/cloud-hosts \
        ansible/deploy-app.yml --ask-vault-pass
                        </code></pre>
                        Once it is finished, visit the new <a href="http://my-app.cat/">website</a>
                    </section>
                

                    <section>
                        <h3>
                            Cleaning up
                        </h3>
                        <ul>
                            <li>
                                When you're all done playing with cats, please clean
                                up your cluster
                            </li>

                            <pre><code data-trim>
        $ ansible-playbook \
           -i ansible/cloud-hosts ansible/remove-hosts.yml \
           -K -e suffix=-$(hostname) --ask-vault-pass
                            </code></pre>
                        </ul>
                    </section>

                </section>
                <section>
                    <section>
                        <h2>
                            Wrap up
                        </h2>
                    </section>
                    <section>
                        <h3>Best Practices</h3>
                        <ul>
                            <li>Goto <a href="https://www.ansible.com/blog/ansible-best-practices-essentials">blog post</a></li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Future topics
                        </h3>
                        <p>
                        Things we can cover in the future:
                        </p>
                        <ul>
                            <li>Simplifying playbooks with roles</li>
                            <li>Managing projects with groups</li>
                            <li>
                                Integrated development workflows
                                <ul>
                                    <li>Continuous Integration/Deployment</li>
                                    <li>Rolling updates</li>
                                </ul>
                            </li>
                        </ul>

                    </section>
                    <section>
                        <h2>
                            The end
                        </h2>
                    </section>
                </section>

                

            </div>

            <!--<div class="footer">
                <div class="scarf">
                    <div class="scarf-orange"></div>
                    <div class="scarf-yellow"></div>
                    <div class="scarf-blue"></div>
                    <div class="scarf-green"></div>
                </div>
                <div class="footer-inner">
                    <div class="catalyst-logo-footer">Catalyst</div>
                    [> NOTE: use only one of these. open-source-technologists is the standard <]
                    <div class="open-source-technologists">open source technologists</div>
                    [> <div class="freedom-to-innovate">freedom to innovate</div> <]
                </div>
            </div>-->
        </div>


        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>
        <script src="js/asciinema-player.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
