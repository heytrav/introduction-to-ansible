<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Introduction to automation with Ansible - Catalyst</title>

        <meta name="author" content="Catalyst">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/catalyst.css" id="theme">
        <link rel="stylesheet" href="css/asciinema-player.css">

        <!-- For syntax highlighting -->
        <!-- <link rel="stylesheet" href="lib/css/zenburn.css"> -->
        <link rel="stylesheet" href="lib/css/solarized-light.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <style>
            /* Add the ability to omit slides from the printed version (has to be after the print include)*/
            @media print {
                .reveal .slides section.no-print {
                    display: none !important;
                    visibility: hidden !important;
                }
            }
        </style>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Please put any custom styles here -->
        <style>

        </style>
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <!-- Cover slide -->
                <section>
                    <h3>Introduction to automation with Ansible</h3>
                    <h1 class="catalyst-logo">Catalyst</h1>
                    <p class="small-text">
                        Presented by <a href="#">Donovan Jones</a>
                    </p>
                </section>


                <!--Remove -->

                <!--<section>
                    <h3>Lets play a game!</h3>
                </section>-->

                <section>
                    <h3>About this course</h3>
                    <ul>
                        <li>A mix of theory and hands on command line tasks</li>
                        <li>Assumes no prior automation or cloud knowledge</li>
                        <li>Assumes some familiarity with the Linux command line</li>
                        <li>Assumes we are using Ubuntu (trusty)</li>
                    </ul>
                </section>

                <section>
                <section>
                    <h3>Course aims - Automation</h3>
                    <ul>
                        <li>Understand why automation is important</li>
                        <li>Understand what automation tools are available and how Ansible compares</li>
                    </ul>
                </section>



                <section>
                    <h3>Course aims - Ansible</h3>
                    <ul>
                        <li>Learn how to install Ansible</li>
                        <li>Understand the basics of how Ansible works</li>
                        <li>Gain familiarity with the <a href="https://docs.ansible.com/ansible/latest/index.html">Ansible Documentation</a></li>
                        <li>Gain Awareness of Ansible Best Practices</li>
                        <li>Gain hands on experience writing and running playbooks</li>
                    </ul>
                </section>
                </section>

                <section>

                <section>
                    <h2>
                        Why use automation tools?
                    </h2>
                </section>
                <section>
                    <h3>
                        Typical application
                    </h3>
<div style="width:50%;float:left;">
                        <img src="img/application-network.svg" alt="basic app
                        network"  >
                    </div>
                    <div style="width:50%;float:left;">
                        <ul style="font-size:18pt;"><li>
                                Applications have many components
                                <ul style="font-size:16pt;">
                                    <li class="fragment" data-fragment-index="0">Web servers</li>
                                    <li class="fragment" data-fragment-index="1">App servers</li>
                                    <li class="fragment" data-fragment-index="2">Load balancers</li>
                                    <li class="fragment" data-fragment-index="3">Database</li>
                                    <li class="fragment" data-fragment-index="4">Caching systems</li>
                                    <li class="fragment" data-fragment-index="5">
                                        Network infrastructure: firewalls, subnets
                                        routers, etc.
                                    </li>


                                </ul>
                            </li>

                                    <li class="fragment"
                                        data-fragment-index="6">Spread across multiple
                                        regions for redundancy</li>
                        </ul>
                    </div>
                    
                </section>
                <section>
                    <h3>
                        Disadvantages of manual deployment
                    </h3>
                    <ul>
                    <li class="fragment" data-fragment-index="0">
                        You could SSH into every machine in your network to
                        <ul>
                            <li>install packages</li>
                            <li>update configuration</li>
                            <li>deploy code</li>
                        </ul>
                    </li>
                        <li class="fragment" data-ragment-index="1">Time consuming</li>
                        <li class="fragment" data-fragment-index="2">Error prone</li>
                    </ul>
                    


                </section>
                <section>
                    <h3>What is Automation?</h3>
                    <ul>
                        <li class="fragment" data-fragment-index="0">Automation is about taking manual processes and placing technology around them to make them repeatable.</li>
                        <li class="fragment" data-fragment-index="1">Automation is the key to speed, consistency, scalability and repeatability.</li>
                    </ul>
                </section>
                
                <section>
                    <h3>Why Automate?</h3>
                    <ul>
                        <li>Scalability</li>
                        <li>Reliability</li>
                        <li>Duplication</li>
                        <li>Consistency</li>
                        <li>Auditability</li>
                        <li>Security</li>
                    </ul>
                </section>
                </section>
               
                <section>
                <section>
                    <h3>Types of Automation</h3>
                    <ul>
                        <li>Provisioning</li>
                        <li>Configuration Management</li>
                        <li>Application Deployment and Continious Delivery</li>
                        <li>Security &amp; Compliance</li>
                        <li>Orchestration</li>
                        <li>Container Orchestration Engines</li>
                    </ul>
                </section>
                <section>
                    <h3>Teachback - Ansible use cases</h3>
                    <p>Each group will review a one of the Ansible <a href="https://www.ansible.com/use-cases">use cases</a> and explain it to the class.</p>
                    <ul>
                        <li><a href="https://www.ansible.com/use-cases/provisioning">Provisioning</a></li>
                        <li><a href="https://www.ansible.com/use-cases/application-deployment">Application Deployment</a></li>
                        <li><a href="https://www.ansible.com/use-cases/configuration-management">Configuration Management</a></li>
                        <li><a href="https://www.ansible.com/use-cases/continuous-delivery">Continuous Delivery</a></li>
                        <li><a href="https://www.ansible.com/use-cases/security-and-compliance">Security &amp; Compliance</a></li>
                        <li><a href="https://www.ansible.com/use-cases/orchestration">Orchestration</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Provisioning</h3>
                    <ul>
                        <li>
                            The act of creating a server, network router,
                            loadbalancer, etc. from some type of image
                        </li>
                        <li>Usually bare metal</li>
                        <li>OS installation</li>
                    </ul>
                </section>
                <section>
                    <h3>Provisioning Tools</h3>
                    <ul>
                        <li>Red Hat Kickstart</li>
                        <li><a href="http://fai-project.org/">FAI</a></li>
                        <li>Debian Preseed</li>
                        <li>Cobbler</li>
                        <li>
                            <a href="https://www.ansible.com/">Ansible</a>
                        </li>
                    </ul>
                </section>
                <section>
                    <h3>Configuration Management</h3>
                    <ul>
                        <li>Best known, often equated with "Automation"</li>
                        <li>Determining the state servers/applications should be in and
                            making sure that conditions are met</li>
                        <li>Agentless vs Agents</li>
                        <li>Often declarative syntax</li>
                    </ul>
                </section>
                <section>
                    <h3>Configuration Management</h3>
                    <ul>
                        <li><a href="https://saltstack.com/">Salt</a></li>
                        <li><a href="https://puppetlabs.com/">Puppet</a></li>
                        <li><a href="https://www.chef.io/">Chef</a></li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Application Deployment</h3>
                    <ul>
                        <li>
                            Take an artefact of development
                            <ul>
                                <li>libraries</li>
                                <li>executable code</li>
                            </ul>
                        </li>
                        <li>
                            Place it on server(s)
                        </li>

                        <li>
                            Make sure it runs on the server
                        </li>

                    
                        <li>Overlaps/integrates with CI/CD tools (eg Jenkins)</li>
                        <li>Quite often bespoke software</li>
                    </ul>
                </section>
                <section>
                    <h3>Application Deployment</h3>
                    <ul>
                        <li><a href="http://www.fabfile.org/">Fabric</a></li>
                        <li><a href="http://capistranorb.com/">Capistrano</a></li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                        <li><a href="https://www.thoughtworks.com/go/">GoCD</a></li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Orchestration</h3>
                    <ul>
                        <li>
                            Concerned with automating workflows
                        </li>
                        <li>
                            Interconnecting components of an application
                            <ul>
                                <li>webservers</li>
                                <li>databases</li>
                                <li>message queues</li>
                                <li>application</li>
                            </ul>
                        </li>
                    </ul>
                </section>
                <section>
                    <h3>Orchestration</h3>
                    <ul>
                        <li><a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a></li>
                        <li><a href="https://wiki.openstack.org/wiki/Heat">OpenStack Heat</a></li>
                        <li><a href="https://www.redhat.com/en/technologies/cloud-computing/cloudforms">Red Hat CloudForms</a></li>
                        <li><a href="https://www.terraform.io/">Hashicorp Terraform</a></li>
                        <li><a href="https://www.ansible.com/">Ansible</a></li>
                    </ul>
                </section>
                <section>
                    <h3>Security &amp; Compliance</h3>
                    <ul>
                        <li>Test Driven Infrastructure as Code</li>
                        <li>Regression testing of security issues</li>
                        <li>PCI or government security standard compliance</li>
                        <li>Security patching</li>
                    </ul>
                </section>
                <section>
                    <h3>Security &amp; Compliance</h3>
                    <ul>
                        <li>Chef Inspec</li>
                        <li>Goss (go)</li>
                        <li>testinfra (python)</li>
                        <li><a href="http://serverspec.org/">Serverspec</a> (ruby)</li>
                    </ul>
                </section>
                <section>
                    <h3>Teachback - Automation tools</h3>
                    <aside class="notes">Choose an automation tool to research, spend a few minutes reading up on it, then report back to the class describing its use case and five important facts about it.</aside>
                    <p>Choose from the list below or choose something yourself.</p>
                    <ul>
                        <li><a href="https://www.terraform.io"></a>Terraform</li>
                        <li><a href="https://www.chef.io/chef/"></a>Chef</li>
                        <li><a href="https://aws.amazon.com/cloudformation/"></a>AWS CloudFormation</li>
                        <li><a href="https://puppet.com/"></a>Puppet</li>
                        <li><a href="https://saltstack.com/"></a>Salt</li>
                        <li><a href="http://capistranorb.com/"></a>Capistrano</li>
                        <li><a href="https://theforeman.org/"></a>Foreman</li>
                        <li><a href="https://www.gocd.org/">GoCD</a></li>
                        <li><a href="https://cfengine.com/">CFEngine</a></li>
                    </ul>
                </section>
                </section>

                <section>
                    <section>
                        <h3>
                            What is Ansible?
                        </h3>
                    </section>
                    <section>
                        <h3>
                            Ansible is a tool for:
                        </h3>
                        <ul>
                            <li>Configuration management</li>
                            <li>Deployment</li>
                            <li>Orchestration</li>
                            <li>Provisioning</li>
                        </ul>
                    </section>
                <section>
                    <h3>Ansible Features</h3>
                    <ul>
                        <li>Based on Python</li>
                        <li>Agentless (nothing to install on remote host)</li>
                        <li>Only requires SSH and Python 2.4 or 2.5</li>
                        <li><em>Push</em> based</li>
                    </ul>
                </section>

                </section>

                <section>
                    <section>
                        <h2>
                            First steps with Ansible
                        </h2>
                    </section>


                    <section>
                        <h3>Installing Ansible</h3>


                        <ul>
                            <li>
                                Target Ansible version &ge; 2.4.2.0
                            </li>
                            <li><a
                               href="http://docs.ansible.com/ansible/latest/intro_installation.html">
                                    Offical documentation</a></li>

                            <li>
                                Explore a couple approaches using:
                                <ul>
                                    <li>OS package manager</li>
                                    <li>Python package manager (pip)</li>
                                </ul>
                            </li>
                        </ul>
                        <aside class="notes">
                            Users should become familiar with Ansible's online docs,
                            therefore many slides will reference those pages directly.
                        </aside>
                    </section>
                    <section>
                        <h3>Requirements</h3>
                        <ul>
                            <li>Requires Python 2.6 or 2.7 on the control machine</li>
                            <li>Requires Python 2.6 on managed nodes</li>
                            <li>Python 3 support is currently a tech preview</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Install Ansible using OS packages</h3>
                        <p>
                        Ansible version available with OS typically a bit out of
                        date
                        </p>
                        <asciinema-player autoplay="0"  loop="loop" font-size="medium" speed="1"
                                                                                       theme="solarized-light" src="lib/apt-cache-policy-ansible.json" cols="200" rows="10"></asciinema-player>

                                                                                   <p>
                                                                                   Add PPA and install from latest source for OS (See
                                                                                   <a href="http://docs.ansible.com/ansible/latest/intro_installation.html#installing-the-control-machine">documentation</a>)
                                                                                   </p>
                    </section>

                    <section>
                        <h3>Installing Ansible in Python virtual environment</h3>
                        <ul>
                            <li><a href="https://pip.pypa.io/en/stable/">PIP</a> - PyPAs <a href="https://packaging.python.org/guides/tool-recommendations/">recommended tool</a> for installing Python packages.</li>
                            <li><a href="https://pypi.python.org/pypi/virtualenv">Virtualenv</a> - PyPAs <a href="https://packaging.python.org/guides/tool-recommendations/">recommended tool</a> for creating isolated Python environments</li>
                            <li>PyPA = Python Packaging Authority</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Install Python Tools</h3>
                        <pre><code data-trim contenteditable>
$ sudo apt-get update
$ sudo apt-get upgrade
$ sudo apt-get install python-pip python-virtualenv
                        </code></pre>
                    </section>
                    <section>
                        <h3>Install Ansible</h3>
                        <pre><code data-trim contenteditable>
$ virtualenv ansible-venv
$ source ansible-venv/bin/activate
(ansible-venv) $ pip install -U pip
(ansible-venv) $ pip install ansible
                        </code></pre>
                        <ul>
                            <li>Create a python virtual environment named <em>ansible-venv</em></li>
                            <li>Activate ansible-venv as base of Python interpreter</li>
                            <li>Update Python package manager (pip)</li>
                            <li>Use Python package manager to install Ansible</li>
                        </ul>

                    </section>
                    <!--<section>
                        <h3>Understanding Virtual Environments</h3>
                        <pre><code data-trim contenteditable>
$ which ansible
/home/train/ansible-venv/bin/ansible
$ ansible --version
ansible 2.4.1.0
  config file = None
  configured module search path = [u'/home/train/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']
  ansible python module location = /home/train/ansible-venv/local/lib/python2.7/site-packages/ansible
  executable location = /home/train/ansible-venv/bin/ansible
  python version = 2.7.6 (default, Oct 26 2016, 20:30:19) [GCC 4.8.4]
                        </code></pre>
                    </section>
                    <section>
                        <h3>Understanding Virtual Environments</h3>
                        <pre><code data-trim contenteditable>
$ env | grep PATH
PATH=/home/train/ansible-venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
$ which ansible
/home/train/ansible-venv/bin/ansible
$ deactivate
                        </code></pre>
                    </section>
                    <section>
                        <h3>Understanding Virtual Environments</h3>
                        <pre><code data-trim contenteditable>
$ which ansible
$ ansible --version
The program 'ansible' is currently not installed. You can install it by typing:
sudo apt install ansible
$ /home/train/ansible-venv/bin/ansible --version
                        </code></pre>
                    </section>-->

                    <section>
                        <h3>Releases</h3>
                        <ul>
                            <li>It is worth keeping up to date with Ansible <a href="https://docs.ansible.com/ansible/latest/release_and_maintenance.html">releases</a></li>
                            <li>Use pip or a PPA to get a recent version</li>
                            <li>Ansible is developed and released on a flexible 4 months release cycle</li>
                            <li>Ansible supports the two most recent major stable releases</li>
                        </ul>
                    </section>

                <section>
                    <h3>Ansible Basics</h3>
                    <h4>
                        Terminology
                    </h4>
                    <div style="width:50%;float:left;">
                        <dl>
                            <dt>Task      </dt> <dd>   An action to perform</dd>
                            <dt>Play      </dt> <dd>   a collection of tasks</dd>
                            <dt>Playbook</dt>   <dd> YAML file containing one or more plays</dd>
                        </dl>
                    </div>
                    <div style="width:50%;float:left;">
                        <img src="img/ansible-workflow.png" />
                    </div>
                </section>
                <section>
                    <h3>Ansible Basics</h3>
                    <h4>
                        More Terminology
                    </h4>
                    <dl>
                        <dt>Module    </dt> <dd>Blob of Python code which is executed to perform task</dd>
                        <dt>Inventory </dt> <dd>File containing hosts and groups of hosts to run tasks</dd>
                    </dl>
                    
                </section>
                <section>
                    <h3>
                        Running Ansible
                    </h3>
                    <ul>
                        <li class="fragment" data-fragment-index="0">
                            There are two ways to run ansible:
                            <ul>
                                <li class="fragment" data-fragment-index="1">
                                    ad hoc
                                    <ul>
                                        <li class="fragment" data-fragment-index="2">Run a single task
                                            
                                        
                                        </li>
                                        <li class="fragment" data-fragment-index="3"><code>ansible &lt;pattern&gt; [options]</code></li>
                                    </ul>
                                </li>

                                <li class="fragment" data-fragment-index="4">
                                    playbook
                                    <ul>
                                        <li>Run multiple tasks sequentially</li>
                                        <li><code>ansible-playbook &lt;pattern&gt; [options]</code></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        
                    </ul>


                       
                </section>
                    <section>
                        <h3>
                           Ad hoc tasks with Ansible
                        </h3>

                        <p>
                        <code>ansible &lt;pattern&gt; [options]</code>
                        </p>
                        <div >
                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    Perform a few <em>ad hoc</em> operations with Ansible 
                                    <ul>
                                        <li>Check connection to server</li>
                                        <li>Install packages</li>
                                        <li>
                                            Run system commands
                                        </li>
                                    </ul>
                                </li>
                                
                            </ul>
                        </div>
                    
                    </section>
                    <section>
                        <h3>
                            Simulating a remote server
                        </h3>

                        <div style="height:50%;">
                            <img src="img/one-vagrant-vm.png" />
                        </div>
                        <ul>
<li class="fragment" data-fragment-index="0">
                                                 For demo purposes in this course we will be using <a
                                                     href="https://www.vagrantup.com/intro/index.html">Vagrant</a> to simulate
                                                  remote hosts.
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Instance(s) use a centos 7 image
                            </li>
                            
                        </ul>

                        <pre class="fragment" data-fragment-index="2"><code data-trim>
                                $ cd $WORKDIR/sample-code/lesson1
                                $ vagrant up --provider virtualbox
                                .
                                
                                ==&gt; default: Machine booted and ready!
                            </code></pre>
                            <p class="fragment" data-fragment-index="3">
                            If all went well you now have a remote host to manage!
                            </p>
                    </section>

                <section>
                    <h3>
                        Executing a basic task
                    </h3>
                    <h4>
                        Ansible behind the scenes
                    </h4>
                        <ul>
                            <li class="fragment" data-fragment-index="0">Create SSH connection to a host or list of
                                hosts (group) in parallel</li>
                            <li class="fragment" data-fragment-index="1">
                                Copy a small blob of executable code to each remote
                                machine
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Performs task: execute the code; capturing return code and
                                output
                            </li>
                            <li class="fragment" data-fragment-index="3">Removes the blob of code</li>
                            <li class="fragment" data-fragment-index="4">Closes the SSH connection</li>
                            <li class="fragment" data-fragment-index="5">Report back on outcome of task</li>
                        </ul>
                </section>
                    <section>
                        <h4>
                            Connecting Ansible to your host
                        </h4>
                        <ul>
                            <li class="fragment"
                                data-fragment-index="0">Ansible works by
                                creating an SSH connection with remote hosts</li>
                            <li class="fragment" data-fragment-index="1">Need
                                a way to tell Ansible how to connect to our
                                Vagrant VM via SSH</li>
                        </ul>
                    </section>
<section>
                        <h3>
                            The Inventory File
                        </h3>
                        <h4>
                            Tell Ansible about remote hosts
                        </h4>
                        <div style="width:50%;float:left;"><ul >

                                <li class="fragment" data-fragment-index="0">
                                    A text file in <code>.ini</code> syntax
                                </li>
                                <li class="fragment" data-fragment-index="1">Identifies hosts for ansible to interact with
                                    <ul>
                                        <li>
                                            Each host on a separate line
                                        </li>
                                    </ul>
                                </li>

                                <li class="fragment"
                                    data-fragment-index="2">Provides optional arguments after host
                                    <ul>
                                        <li>connection information</li>
                                        <li>
                                            other arbitrary variables for
                                            specific host
                                        </li>
                                    </ul>
                                </li>

                            </ul></div>

                            <div class="fragment" data-fragment-index="1" style="float:left;width:50%;"><pre><code data-trim>
                            #sample inventory

                            web1.mycompany.com
                            web2.mycompany.com
                            app1.mycompany.com

                            db.mycompany.com
                            lb.mycompany.com

                            [auckland]
                            web1.mycompany.com
                            
                            [wellington]
                            web2.mycompany.com
                            </code></pre></div>
                            


                    </section>
                    <section>
                        <h3>
                            The Inventory File
                        </h3>
                        <h4>
                            Sample inventory file
                        </h4>
                        
                        <pre><code data-trim>
                                    [web]
                                    web1.mycompany.com ansible_host=152.240.43.12 opt2=arg2
                                    web2.mycompany.com

                                    [db]
                                    db1.mycompany.com

                                    [app]
                                    app1.mycompany.com
                                    app2.mycompany.com

                                    [lb]
                                    loadbalancer.mycompany.com
                        </code></pre>


                    </section>
                    
                    <section>
                        <h3>
                            The Inventory File
                        </h3>
                        <h4>
                            Grouping your remote hosts
                        </h4>
                        <div style="width:50%;float:left;"><ul>

                                <li class="fragment" data-fragment-index="0">
                                    Sections used to organise hosts into
                                    <em>groups</em>
                                    <ul>
                                        <li>functional roles</li>
                                        <li>separate regions</li>
                                    </ul>
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Either group or specific hosts can be used in
                                    ansible commands
                                </li>
                              

                            </ul></div>
                            <div class="fragment" data-fragment-index="0" style="width:50%;float:left">
                                <pre><code data-trim>
                                    # sample inventory
                                    [web]
                                    web1.mycompany.com
                                    web2.mycompany.com

                                    [app]
                                    app1.mycompany.com
                                    app2.mycompany.com

                                    [wellington]
                                    web1.mycompany.com
                                    app1.mycompany.com

                                    [auckland]
                                    web2.mycompany.com
                                    app2.mycompany.com

                                </code></pre>
                            </div>


                    </section>
                    <section>
                        <h3>
                            Our first inventory file
                        </h3>
                        <pre><code data-trim>
                            $ cat $WORKDIR/sample-code/lesson1/ansible/hosts
                        </code></pre>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Our inventory file specifies single remote host: <em>myserver</em>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                To connect to our Vagrant VM we need to
                                set some special connection variables
                                <ul>
                                    <li><code>ansible_host</code></li>
                                    <li><code>ansible_user</code></li>
                                    <li><code>ansible_port</code></li>
                                    <li><code>ansible_private_key_file</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Variables specified on same line as host
                            </li>
                            
                        </ul>

                    </section>
                    
                    <section>
                        
                        <h4>
                            Exercise: edit your inventory file to fill in missing
                            connection information
                        </h4>
                        <pre><code data-trim>$ vagrant ssh-config
Host default
    HostName ???
    User ???
    Port ???
    .
    IdentityFile ???
    .
    
                        </code></pre>
                        <p>
                        Use the values from your host to fill in missing
                        arguments in <code>ansible/hosts</code>
                        </p>
                    </section>
                    <section>
                        <h3>
                            Running <em>ad hoc</em> Ansible commands
                        </h3>
                        <p>
                        <code>ansible &lt;host pattern&gt; [OPTIONS]</code>
                        </p>
                        <ul>
                            <li>
                                <em>host pattern</em> can be:
                                <ul>
                                    <li>the name of a specific host in inventory</li>
                                    <li>a <em>group</em> of hosts from the inventory</li>
                                </ul>
                            </li>

                        </ul>
                        <table class="fragment" data-fragment-index="1">
                            <tr>
                                <th>Option    </th>
                                <th>Argument                  </th>
                                <th>Description</th>
                            </tr>
                            <tr><td> -m              </td>  <td>string</td>  <td>  module name to execute; default to <em>command</em> module</td></tr>
                            <tr><td> -a              </td>  <td>string</td>  <td>  arguments to module</td></tr>
                            <tr><td> -i              </td>  <td>string</td> <td>                 path to inventory file </td></tr>
                            <tr><td> -b              </td>  <td></td>        <td>         Run operations with become</td></tr>
                            <tr><td> --become-method</td> <td>string</td>
                                <td>Which become method to use. Default sudo                                 </td></tr>
                        </table>
                    </section>
                    <section>
                        <h4>
                            Exercise: Ping our remote host
                        </h4>
                        <p class="fragment" data-fragment-index="0">
                        <a
                                            href="https://docs.ansible.com/ansible/latest/ping_module.html"><em>ping</em></a>
                        is an Ansible module that just checks whether or not
                        Ansible can create a SSH sessions with hosts.
                        </p></h4>
                        <p class="fragment" data-fragment-index="1">
                        Use the <em>ping</em> module to check if our host accepts SSH
                        connections
                        </p>
                        <pre class="fragment" data-fragment-index="2"><code
                        data-trim>$ ansible myserver -i ansible/hosts -m ping
myserver | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
                        </code></pre>
                        

                    </section>

                    <section>
                        <h3>
                            The ansible.cfg file
                        </h3>
                        <h4>
                            Simplify our inventory file
                        </h4>
                        <pre class="fragment" data-fragment-index="0"><code data-trim>
    # sample ansible.cfg

    [defaults]
    inventory = hosts
    remote_user = vagrant
    private_key_file = .vagrant/machines/default/virtualbox/private_key
    host_key_checking = False
                            </code></pre>    
                        
                            <ul>
                                <li class="fragment" data-fragment-index="1">
                                    A way to set some defaults for ansible
                                    instead of in inventory file

                                </li>
                                <li class="fragment" data-fragment-index="2">
                                    .ini syntax
                                </li>
                                <li class="fragment" data-fragment-index="3">
                                    Specify SSH connection, which inventory
                                    file to use
                                </li>
                            </ul>
                    </section>
                    <section>
                        <h3>
                            The ansible.cfg file
                        </h3>
                        <h4>
                            Where Ansible looks for it
                        </h4>

                        <ul>
                            <li class="fragment" data-fragment-index="0">4 possible locations in order of priority
                                <ul>
                                    <li class="fragment" data-fragment-index="1">File specified by ANSIBLE_CONFIG</li>
                                    <li class="fragment" data-fragment-index="2">Current directory (<code>ansible.cfg</code>)</li>
                                    <li class="fragment" data-fragment-index="3">Home directory (<code>~/.ansible.cfg</code>)</li>
                                    <li class="fragment" data-fragment-index="4">/etc/ansible/ansible.cfg</li>
                                </ul>
                            </li>
                        </ul>
                        
                    </section>
                    <section>
                        <h4>
                            Exercise: Set up ansible.cfg and modify inventory file
                        </h4>
                        <p>
                        <code>$WORKDIR/sample-code/ansible.cfg.sample</code>
                        </p>
                        <p>
                        Use config to simplify your inventory file.
                        </p>
                        
<pre class="fragment" data-fragment-index="0"><code data-trim>
                            $ cd $WORKDIR/sample-code/lesson1
                            $ cp ../ansible.cfg.sample ansible.cfg
                            $ cat $WORKDIR/lesson1/hosts
                            myserver ansible_host=127.0.0.1 ansible_port=2222
                        </code></pre>
                        <p class="fragment" data-fragment-index="1">
                        You now no longer need to specify an inventory file
                        </p>
                        <pre class="fragment" data-fragment-index="1"><code data-trim>
                            $ ansible myserver -m ping
                        </code></pre>

                    </section>

                <section>
                    <h3>Ansible Modules</h3>
                    <ul>
                        <li class="fragment" data-fragment-index="0">Blob of python that performs a very specific action</li>
                        <li class="fragment" data-fragment-index="1">Ship with Ansible</li>
                        <li class="fragment" data-fragment-index="2">More than
                            200 <a
                                href="https://docs.ansible.com/ansible/latest/list_of_all_modules.html">Ansible
                            modules</a></li>
                        <li class="fragment" data-fragment-index="3">
                            When you run Ansible:
                            <ul>
                                <li>SCP to temporary directory on target host</li>
                                <li>Execute python on target host</li>
                                <li>Returns JSON</li>
                                <li>Code removed from target host</li>
                                <li>Local Ansible evaluates returned JSON</li>
                                <li>Output ok/changed/failed for task based on returned values</li>
                            </ul>
                        </li>

                    </ul>
                </section>

                <section>
                    <h3>
                        Example: The <em>command</em> module
                    </h3>
                    <p style="font-size:16pt;">
                    <code>ansible &lt;host pattern&gt; -m command -a &lt;args to command&gt;</code>
                    </p>
                        
                    <ul>
                        <li class="fragment" data-fragment-index="0">Execute
                            arbitrary command on remote system</li>
                        <li class="fragment" data-fragment-index="1">The default module
                        </li>
                        <li class="fragment" data-fragment-index="2">
                            These are equivalent:
                            <ul>
                                <li><code>ansible myserver -m command -a uptime</code></li>
                                <li><code>ansible myserver -a uptime</code></li>
                            </ul>
                        </li>
                        
                        <li class="fragment" data-fragment-index="3">
                            <a
                               href="https://docs.ansible.com/ansible/latest/command_module.html">Documentation</a>
                        </li>
                    </ul>
                </section>

                <section>
                    <h4>
                        Exercise: Get tail of system messages on your vagrant host
                    </h4>
                    <p>
                    <em>Note</em>: On centos it will be /var/log/messages
                    </p>
                    <pre class="fragment" data-fragment-index="0"><code data-trim>
                        $ ansible myserver  -b -a "tail /var/log/messages"
                    </code></pre>
                </section>
                <section>
                    <h4>Exercise: install a package</h4>
                    <p >
                    Use the <a href="https://docs.ansible.com/ansible/latest/yum_module.html"><em>yum</em></a> module to install <em>mtr</em> (network
                    monitoring tool)
                    </p>
                    <pre class="fragment" data-fragment-index="0"><code data-trim>
                        $ ansible myserver -b -m yum -a "name=mtr state=present"
                    </code></pre>
<asciinema-player class="fragment" data-fragment-index="1"  autoplay="0"  loop="loop" font-size="medium" speed="1"
     theme="solarized-light" src="lib/ansible-install-mtr.json" cols="200" rows="17"></asciinema-player>
                </section>

                <section>
                    <h3>
                        Module documentation
                    </h3>

                    <ul>
                        <li class="fragment" data-fragment-index="0">
                            Places you can find module documentation

                            <ul>
                                <li class="fragment" data-fragment-index="1"><a
                                        href="https://docs.ansible.com/ansible/latest/list_of_all_modules.html">The
                                        ansible community docs</a></li>
                                <li class="fragment" data-fragment-index="2">
                                    Inline documentation

                                </li>
                            </ul>
                        </li>
                    </ul>
                    <pre class="fragment" data-fragment-index="2"><code data-trim>
    $ ansible-doc yum

    &gt; YUM    (~/venv/local/lib/python2.7/site-packages/ansible/modules/packaging/os/yum.py)

            Installs, upgrade, downgrades, removes, and lists packages and groups with the `yum' package manager.

    OPTIONS (= is mandatory):

    - allow_downgrade
            Specify if the named package and version is allowed to downgrade a maybe already installed higher version of that package. Note that setting
            allow_downgrade=True can make this module behave in a non-idempotent way. The task could end up with a set of packages that does not match the complete
            list of specified packages to install (because dependencies between the downgraded package and others can cause changes to the packages which were in
            the earlier transaction).
            (Choices: yes, no)[Default: no]
            version_added: 2.4
                    </code></pre>
                </section>

                <section>
                    <h3>
                        Summary
                    </h3>

                    <ul>
                        <li>
                            This section has given you a small taste of using
                            Ansible in <em>ad hoc</em> mode
                        </li>
                        <li>
                            Interacted with a remote server
                            <ul>
                                <li>Check if SSH works</li>
                                <li>Install OS packages</li>
                                <li>Start services</li>
                            </ul>
                        </li>
                        <li>
                            Explore documetation with <code>ansible-doc</code>
                        </li>
                    </ul>
                </section>
                
                </section>

                <section>
                    <section>
                        
                        <h3>
                            Configuration management with Ansible
                        </h3>
                    </section>
                    <section>
                        <h3>
                            Ansible Playbook
                        </h3>
                        <ul>
                            <li>
                                Run sequences of tasks
                            </li>
                            <li>Primary means of:
                                <ul>
                                    <li>Configuration management</li>
                                    <li>
                                        Deploying applications
                                    </li>
                                    <li>Provisioning</li>
                                    <li>Orchestration</li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    

                    <section>
                        <h3>
                            Working with Ansible Playbooks
                        </h3>
                        
                        <pre><code data-trim>
                            $ cd $WORKDIR/sample-code/lesson2
                            .
                             ansible
                              files
                               nginx.conf
                              hosts
                              playbook.yml
                              templates
                                  index.html.j2
                             ansible.cfg
                        </code></pre>
                        
                       <table>
                           <tr>
                               <th>Name  </th>
                               <th>Type </th>
                               <th>Description</th>
                           </tr>
                           <tr><td>playbook.yml</td>  <td>file      </td><td>  Ansible Playbook</td></tr>
                           <tr><td>files       </td>  <td>directory </td><td> Contains artefacts to be placed on remote host</td></tr>
                           <tr><td>templates   </td>  <td>directory </td><td>
                                   Contains templates that will be rendered
                                   and uploaded to remote host</td></tr>
                       </table>
                    </section>

                    <section>
                        <h3>
                            Deploy and configure an application
                        </h3>
                        <img src="img/ansible-nginx-install.svg" />
                        <ul>
                        <li>
                            Our Ansible playbook needs to do the following on our
                            Vagrant VM:

                            <ul>
                                <li class="fragment" data-fragment-index="0">Install nginx package</li>
                                <li class="fragment"
                                    data-fragment-index="1">Copy our nginx
                                    config (<code>files/nginx.conf</code>)</li>
                                <li class="fragment"
                                    data-fragment-index="2">Render
                                     template file
                                     (<code>templates/index.html.j2</code>)
                                     and place it on host</li>
                                <li class="fragment" data-fragment-index="3">Re/Start nginx</li>
                            </ul>

                        </li>
                        </ul>
                    </section>
                    

                    
                    <section>
                        <h3>
                            Ansible Playbook Structure
                        </h3>
                        

                        <div style="width:50%;float:left;">
                            <img src="img/playbook-anatomy.svg"/>
                        </div>

                        <div style="width:50%;float:left;">
<ul>
                            <li class="fragment" data-fragment-index="0">
                                A playbook is a YAML file containing a list of
                                <em>plays</em>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                A play is a dictionary object

                                <ul><li>
                                        <code style="color:red;">key</code><code>: </code><code style="color:blue;">value</code>
                                    </li></ul>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Some keys in a play may contain dictionaries or
                                lists
                            </li>
                            
                            
                        </ul>
                        </div>

                        

                    </section>

                    <section>
<h3>
                            Ansible Playbook Structure
                        </h3>
                        <ul>
                            
                            <li class="fragment" data-fragment-index="1">
                                A play must contain following keys:
                                <ul>
                                    <li class="fragment" data-fragment-index="2"><code>hosts</code>
                                        <ul>
                                            <li>
                                                A string
                                            </li>
                                            <li>
                                                These are what you will configure
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="fragment" data-fragment-index="3">tasks
                                        <ul>
                                            <li>
                                                A list of dictionaries
                                            </li>
                                            <li>
                                                What you want to do
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="4">
                                Optionally
                                <ul>
                                    <li>name - description of the play</li>
                                    <li>vars - variables scoped to the play</li>
                                    <li>etc.</li>
                                </ul>
                            </li>
                        </ul></section>
                        <section>
                            <h3>
                                Privilege Escalation
                            </h3>

                            <ul style="width:90%;font-size:18pt;">
                                <li>
                                    Note the <em>become</em> line in <code>playbook.yml</code>
                                    
                                    <pre style="font-size:18pt;"><code data-trim>
    - name: Set up static website with nginx
      hosts: myserver
      become: true &lt;--
      tasks:
                                    </code></pre>
                                </li>
                                <li class="fragment" data-fragment-index="0">
                                    Normally ansible tasks run on a host as an unprivileged user
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Most tasks in our playbook require <em>sudo</em> privileges to run
                                </li>
                                <li class="fragment" data-fragment-index="2">
                                    The <em>become</em> clause:
                                    <ul>
                                        <li class="fragment" data-fragment-index="3">
                                            Tells ansible to run tasks as a certain
                                            user (default sudo)
                                        </li>
                                        <li class="fragment" data-fragment-index="4">
                                            Can be in play or task scope
                                        </li>
                                        <li class="fragment" data-fragment-index="5">
                                            Accepts: <em>true</em> or
                                            <em>yes</em>, <em>false</em> or <em>no</em>
                                        </li>
                                    </ul>
                                </li>
                            </ul>

                        </section>


<section>
                        <h3>
                            Structure of a playbook task
                        </h3>
                        
                        <ul>
                            <li>
                                A task is a dictionary object containing
                                <ul>
                                    <li>name 
                                        <ul>
                                            <li>Describes what the task does</li>
                                            <li>
                                                optional but highly recommended
                                            </li>
                                        </ul></li>
                                        <li>module 
                                            <ul>
                                                <li>
                                                    Dictionary object
                                                </li>
                                                <li>
                                                    Key represents Python
                                                    module which will perform
                                                    tasks
                                                </li>
                                                <li>
                                                    May have arguments
                                                </li>
                                            </ul>

                                        </li>
                                </ul>
                            </li>

                        </ul>
                        
                    </section>
                    <section>
                        <h3>
                            Structure of a playbook task
                        </h3>
                        
                        <div style="width:50%;float:left;">
                            <img src="img/playbook-task-anatomy.svg"/>
                        </div>
                        <div style="width:50%;float:left;">
                            <ul>
                                <li>
                                    Two styles of module object in tasks
                                    <ul>
                                        <li>string form</li>
                                        <li>dictionary form</li>
                                    </ul>
                                </li>
                                <li>
                                    Dictionary form is more suitable for complex
                                    arguments
                                </li>
                                <li>
                                    Matter of
                                    preference/style
                                </li>
                            </ul>


                        </div>


                    </section>
                    
<section>
                        <h3>
                            Run our first playbook
                        </h3>
                        <pre><code data-trim>
                            $ cd $WORKDIR/sample-code/lesson2
                            $ ansible-playbook ansible/playbook.yml
                        </code></pre>
                        
<asciinema-player  autoplay="0"  loop="loop" font-size="medium" speed="1"
     theme="solarized-light" src="lib/basic-static-site.json" cols="200" rows="15"></asciinema-player>
 <p class="fragment" data-fragment-index="0">
 Visit <a href="http://localhost:8080">static site</a>
 </p>
                    </section>

                    <section>
                        <h3>
                            Summary 
                        </h3>
                        <ul>
                            <li>Use Ansible Playbook to run complex tasks</li>
                            <li>Playbook consists of array of YAML dictionaries called <em>plays</em></li>
                            <li>
                                Each play contains array of tasks that are
                                executed on remote host
                            </li>
                        </ul>

                    </section>

                </section>

                <section>
                    <section>
                        <h2>
                            Ansible Variables
                        </h2>
                    </section>
                    <section>
                        <h3>
                            Ansible Variables
                        </h3>
                        <ul>
                            <li>
                                Several different types:
                                <ul>
                                    <li>inventory variables</li>
                                    <li>play scoped variables</li>
                                    <li>task variables</li>
                                    <li>
                                        extra variables
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </section>

                    <section>

                        <h3>
                            Inventory Variables
                        </h3>
                        <ul>
                            <li>
                                Are scoped to a host throughout the execution of a playbook
                            </li>
                            <li>
                                Assigned in 
                                <ul>
                                    <li>
                                        the inventory file
                                    </li>
                                    <li>
                                         Subdirectories
                                        <ul>
                                            <li>host_vars/&lt;host&gt;</li>
                                            <li>group_vars/&lt;group&gt;</li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                Can be referenced directly when executing play on
                                host
                            </li>
                            <li>
                                Available in <em>hostvars</em> dictionary
                            </li>
                            
                        </ul>
                    </section>
                    <section>
                        <h2>
                            Inventory Variables
                        </h2>

                        <h3>
                            In inventory file
                        </h3>
<pre class="fragment" data-fragment-index="0"><code data-trim>
                                    # assign variable to single host
                                    [web]
                                    web1.mycompany.com ansible_host=152.240.43.12 opt2=arg2
                                    web2.mycompany.com
                                    .
                        </code></pre>
<pre class="fragment" data-fragment-index="1"><code data-trim>
                                    # assign variable to group of hosts

                                    [web]
                                    web1.mycompany.com ansible_host=152.240.43.12
                                    web2.mycompany.com

                                    [web:vars]
                                    proxy=web.mycompany.com

                        </code></pre>
                    </section>


                    

                    <section>
                        <h3>
                            Inventory Variables
                        </h3>
                        <h4>
                            host_vars/&lt;host&gt;
                        </h4>
                        <p>
                        Create a <em>host_vars</em> directory and variable file 
                        </p>
                        <pre><code data-trim>
                            $ mkdir $WORKDIR/sample-code/lesson2/ansible/host_vars
                            $ vim $WORKDIR/sample-code/lesson2/ansible/host_vars/myserver.yaml
                        </code></pre>
                        <pre><code data-trim>
                            # variables for myserver
                            ---
                            foo: bar
                        </code></pre>

                    </section>
                    <section>
                        <h3>
                            Inventory Variables
                        </h3>
                        <h4>
                            group_vars/&lt;group&gt;
                        </h4>
                        <pre><code data-trim>
                            $ less $WORKDIR/sample-code/lesson2/ansible/hosts
                        </code></pre>
                        <p>
                        Create a <em>group_vars</em> directory and variable file 
                        </p>
                        <pre><code data-trim>
                            $ mkdir $WORKDIR/sample-code/lesson2/ansible/group_vars
                            $ vim $WORKDIR/sample-code/lesson2/ansible/group_vars/web.yaml
                        </code></pre>
                        <pre><code data-trim>
                            # variables for "web" group
                            ---
                            bizz: buzz
                        </code></pre>

                    </section>
                    <section>
                        <h3>
                            Using Inventory variables
                        </h3>
                        <pre><code data-trim>
                        $ less $WORKDIR/sample-code/lesson2/ansible/templates/index.html.j2
                        .
                        .
                        {% if foo is defined %}
                        &lt;p&gt;
                        The value for foo is &lt;em&gt;{{ foo }}&lt;/em&gt;
                        &lt;/p&gt;
                        {% endif %}
                        {% if bizz is defined %}
                        &lt;p&gt;
                        The value for bizz is &lt;em&gt;{{ bizz }}&lt;/em&gt;
                        &lt;/p&gt;
                        {% endif %}
                        .
                        .
                        </code></pre>
                        <p>
                        Inventory variables accessed directly in templates
                        </p>
                    </section>

                    <section>
                        <h3>
                            Using Inventory Variables
                        </h3>
                        <pre><code data-trim>
                            $ ansible-playbook ansible/playbook.yaml
                        </code></pre>
                        <ul>
                            <li>Run the ansible-playbook again</li>
                            <li>Note behaviour of <em>Copy up static website html</em> task</li>
                            <li>Reload <a href="http://localhost:8080">website</a>  when finished</li>
                        </ul>
                    </section>
                    <section><h3>
                            hostvars
                        </h3>
                        <ul style="font-size:18pt;width:100%;">
                            <li class="fragment" data-fragment-index="0">
                                dictionary with                                variables from each host (including inventory variables) </li>
                            <li class="fragment" data-fragment-index="1">
                                    indexed on hostname from inventory 
                                <ul>
                                    <li><code>hostvars['myserver']['foo'] ==  hostvars.myserver.foo</code></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Can be accessed across plays in the same playbook run
                            </li>
                            <li class="fragment" data-fragment-index="3">
                                Have a look at <code>playbook-localhost.yml</code>
                            </li>
                            <li class="fragment" data-fragment-index="4">
                                Run <code>playbook.yml</code> and <code>playbook-localhost.yml</code>
                                <pre ><code data-trim>
                                $ ansible-playbook ansible/playbook.yml ansible/playbook-localhost.yml
                                </code></pre>
                                
                            </li>
                            <li class="fragment" data-fragment-index="6">
                                Change <code style="color:red;">foo</code> to
                                <code style="color:red;">hostvars.myserver.foo</code> in
                                <code>playbook-localhost.yml</code> and run
                                playbooks
                            </li>
                            
                        </ul>

                    
                    </section>

                    <section>
                        <h4>
                            Excercise: View a group variable from hostvars
                        </h4>
                        <ul style="width:100%;">
                            <li>
                                The bizz variable still appears as undefined in
                                playbook run
                            </li>
                            <li>
                                How would you find that in hostvars?
                            </li>
                            <li>
                                A group variable will be defined for every
                                host in a group
                                <pre><code data-trim>
                                    - name: Output of bizz
                                      debug:
                                        var: hostvars.myserver.bizz
                                </code></pre>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Play scoped variables
                        </h3>

                        <ul>
                            <li>
                                Declared in control section of a play
                                <ul>
                                    <li>vars - static declaration</li>
                                    <li>vars_prompt - interactively prompt user when running playbook</li>
                                </ul>
                            </li>
                            <li>
                                Can be referenced directly while in play
                            </li>
                            
                        </ul>


                    </section>
                    <section>
                        <h3>
                            Play scoped varibles
                        </h3>
                        <ul style="font-size:18pt;width:100%;">
                            <li class="fragment" data-fragment-index="0">
                                Open <code>playbook.yml</code> in editor
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Edit as shown:

                        <pre style="font-size:18pt;" ><code data-trim>
    - name: Set up static website with nginx
      hosts: myserver
      become: true
      # new section
      vars_prompt:
        - name: "participant_name"
          prompt: "What is your name"
          private: no
      vars:
        course: Introduction to ansible
        lesson:
          name: Working with play variables
          session: 1
      # end new section
      tasks:
      .
      .

                        </code></pre>
                            </li>
                            <li class="fragment" data-fragment-index="2">
                                Rerun ansible-playbook
                            </li>
                        </ul>
                        


                    </section>

                    <section>
                        <h3>
                            Task Variables
                        </h3>
                        <ul>
                            <li>Contain data discovered while executing a task</li>
                            <li>Gathering facts phase of play execution</li>
                            <li>
                                Tasks that gather user input
                            </li>
                            <li>Become part of the host scope once defined</li>
                            <li>In a play they can be directly referenced</li>
                            <li>In subsequent plays are available in hostvars dictionary for host</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>
                            Assigning task variables
                        </h3>
                        <h4>
                            Using the <code>set_fact</code> module
                        </h4>
                        

                        <pre><code data-trim>
                        tasks:
                          - name: Assign an arbitrary variable
                            set_fact:
                              name: Homer Simpson

                          - name: Assign dictionary
                            set_fact:
                              person_details:
                                street: 754 Evergreen Terrace
                                city: Springfield
                                state: ST
                        </code></pre>
                    </section>
                    <section>
                        <h3>
                            Assigning task variables
                        </h3>
                        <h4>
                            Capturing output with <em>register</em> attribute
                        </h4>

                        <pre><code data-trim>
                            - name: Execute code and capture the output
                              command: uptime
                              register: uptime_output

                              .
                              .
                            - name: do something with output of uptime
                              debug:
                                var: {{ uptime_output.stdout }}
                        </code></pre>
                    </section>

                    <section>
                        <h4>
                            Exercise: Assign some task variables
                        </h4>
<pre class="fragment" data-fragment-index="0"><code data-trim>
    tasks:
        - name: set name of person
          set_fact:
            person_name: Homer Simpson

        - name: Get output of uptime
          command: uptime
          register: uptime_output
        .
        .
                        </code></pre>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Use <code>set_fact</code> and
                                <code>register</code> in playbook.yml to assign task variables
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Rerun ansible playbook
                            </li>
                        </ul>

                        

                    </section>

                    <section>
                        <h3>
                            Gathering facts
                        </h3>
                        <ul>
                            <li>
                                Plugin run  before play executes
                                <ul>
                                    <li>
                                        <code>setup</code> module
                                    </li>
                                </ul>
                            </li>
                            <li>
                                Collects detailed information about host and attaches to host scope
                            </li>
                            <li>
                                You can get an idea by running
                                <ul>
                                    <li>
                                        <code> ansible myserver -m setup </code>
                                    </li>
                                </ul>
                            </li>
                            <li>
                                Filter facts to find variables you are
                                interested in:
                                <ul>
                                    <li>
                                        <code style="font-size:15pt;">
                                            ansible myserver -m setup -a 'filter=ansible_distribution*'
                                        </code>
                                    </li>
                                </ul>
                            </li>
                        </ul>

                    </section>

                    <section>
                        <h3>
                            Exercise: Display system facts
                        </h3>

                        <p>
                        Uncomment area in <code>templates/index.html.j2</code>
                        </p>


                        <pre><code data-trim>
        &lt;!--   remove line
        {% if ansible_distribution is defined %}
            &lt;p&gt;  
            System facts: {{ ansible_distribution }} {{ ansible_distribution_major_version }} {{ ansible_architecture }}
            &lt;/p&gt;
        {% endif %}
        --&gt;   remove line
                        </code></pre>
                        <p class="fragment" data-fragment-index="0">
                        Re-run ansible-playbook and visit <a href="http://localhost:8080">static website</a>
                        </p>
                    </section>

                    <section>
                        <h3>
                            Exercise: Turn off gather facts
                        </h3>
                        <p>
                        Edit playbook.yml as follows
                        </p>

                        <pre><code data-trim>
                            - name: Set up static website with nginx
                              hosts: myserver
                              become: true
                              gather_facts: false   # &lt;-- add this line
                              tasks:
                                .
                                .
                        </code></pre>
<p class="fragment" data-fragment-index="0">
                        Re-run ansible-playbook and visit <a href="http://localhost:8080">static website</a>
                        </p>
                    </section>

                    <section>
                        <h3>
                            Extra variables
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Variables passed to ansible or
                                ansible-playbook via
                                command line
                            <ul>
                                <li class="fragment"
                                    data-fragment-index="1"><code
                                        style="font-size:15pt;">ansible-playbook
                                        --extra-vars="key1=value1 key2=value2"
                                playbook.yml</code></li>
                                <li class="fragment"
                                    data-fragment-index="2"><code
                                    style="font-size:15pt;">ansible-playbook
                                    -e key1=value1 -e key2=value2 playbook.yml</code></li>
                                <li class="fragment"
                                    data-fragment-index="3"><code
                                        style="font-size:15pt;">ansible-playbook
                                        -e @extra-variables.yml playbook.yml</code></li>
                            </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Variable precedence
                        </h3>
                        <ul><li>
                                Ansible variables in order of increasing
                                precedence:
                                <ul>
                                    <li>inventory file</li>
                                    <li>host facts</li>
                                    <li>play vars_files</li>
                                    <li>task vars</li>
                                    <li>include_vars</li>
                                    <li>set_facts/registered variables</li>
                                    <li>extra vars</li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="0">
                            <a
                                href="https://docs.ansible.com/ansible/latest/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">complete
                                list</a>
                            </li>
                        </ul>

                    </section>
                    <section>
                        <h3>
                            Exercise: variable precedence
                        </h3>
                        <p>
                        Pass extra vars to ansible playbook to override
                        previous examples
                        </p>

                        <pre><code data-trim>
                        $ ansible-playbook ansible/playbook.yml \
                           -e person_name="Marge Simpson" \
                           -e '{"lesson": {"name": "Override variables", \
                           "session": 2}}'
                        </code></pre>
                    </section>
                    
                    <section>
                        <h3>
                            Summary
                        </h3>
                        <ul><li>
                                There are several types of variables in Ansible
                                <ul>
                                    <li>inventory</li>
                                    <li>play scoped</li>
                                    <li>task variables</li>
                                    <li>extra </li>
                                </ul>
                            </li>
                        </ul>
                    </section>








                
                </section>

                <section>
                    <section>
                        <h2>
                            Templating in Ansible
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Templating in Ansible
                        </h3>
                        <ul>
                            <li>
                                Sometimes you need dynamic behaviour in plays/tasks
                                <ul>
                                    <li>File locations</li>
                                    <li>Fill in prompted information</li>
                                    <li>
                                        secret info (passwords, API keys)
                                    </li>
                                    <li>Generally sourced from a variable</li>
                                </ul>
                            </li>
                            <li>
                                Ansible uses a template syntax called Jinja2
                            </li>
                        </ul></section>

                        <section>
                            <h3>
                                Jinja2
                            </h3>
                            <h5>
                                A very very brief intro
                            </h5>


                            <ul>
                                
                                <li>
                                    Provides tools for
                                    <ul>
                                        <li>passing variables</li>
                                        <li>evaluating expressions</li>
                                        <li>filters</li>
                                        <li>etc.</li>
                                    </ul>
                                </li>
                                <li>
                                    References
                                    <ul>
                                        <li><a href="https://docs.ansible.com/ansible/latest/playbooks_templating.html">Templating in Ansible</a></li>
                                        <li><a href="http://jinja.pocoo.org/docs/2.10/templates/">Jinja2 official docs</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </section>
                        <section>
                            <h3>
                                Basic Jinja2
                            </h3>
                            <h5>
                                Variables
                            </h5>
                            <ul>
                                <li>
                                    Simple variables or expressions
                                    <ul>
                                        <li>
                                            <code style="font-size:15pt;">{{ person_name  }}</code> 
                                        </li>
                                        <li>
                                            <code style="font-size:15pt;">{{ 1 + 1 }}</code> 
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    Dictionaries
                                    <ul>
                                        <li><code style="font-size:15pt;">{{ lesson['name'] }}</code></li>
                                        <li><code style="font-size:15pt;">{{ lesson.name }}</code></li>
                                        <li><code style="font-size:15pt;">{{ hostvars['myserver'].ansible_distribution }}</code></li>
                                    </ul>
                                </li>

                            </ul>

                        </section>

                        <section>
                            <h3>Basic Jinja2</h3>

                            <h5>
                                Filters
                            </h5>
                            <ul>
                                <li>Let's just look at the <a href="https://docs.ansible.com/ansible/latest/playbooks_filters.html">offical documentation</a></li>
                            </ul>
                        </section>
                        <section>
                            <h4>
                                Exercise: Templating in our playbook
                            </h4>
                            <ul>
                                <li>
                                    Edit <code>vars</code> section in <code>playbook.yml</code> to add:
                                    <ul>
                                        <li><code style="font-size:15pt;">static_file_directory</code></li>
                                        <li><code style="font-size:15pt;">nginx_conf_directory</code></li>
                                    </ul>
                                </li>
                            </ul>

                            <pre><code data-trim>
                                vars:
                                  .
                                  static_file_directory: /usr/share/nginx/html
                                  nginx_conf_directory: /etc/nginx/conf.d 
                                tasks:
                            </code></pre>
                        </section>

                        
                        <section>
                            <h4>
                                Exercise: Templating in our playbook
                            </h4>
                            <ul>
                                <li>
                                    Use template syntax to replace path for
                                    <ul>
                                        <li>nginx</li>
                                        <li>index.html</li>
                                    </ul>
                                </li>
                            </ul>

                            <pre class="fragment" data-fragment-index="0"><code data-trim>
        - name: Copy in nginx config file
          copy:
            .
            dest: "{{ nginx_conf_directory }}/nginx.conf"
            .

        - name: Copy up static website html
          template:
            .
            dest: "{{ static_file_directory }}/index.html"
            .
                            </code></pre>
                            <p class="fragment" data-fragment-index="1">
                            Re-run the ansible playbook
                            </p>
                        </section>
                        <section>
                            <h3>
                                Templates and Quoting
                            </h3>
                            <ul style="width:80%;">
                                <li>
                                    Be aware that you will often need to put quotes
                                    around values when using templates
                                    <pre><code data-trim>
                                        dest: "{{ nginx_conf_directory }}/nginx.conf"
                                    </code></pre>
                                </li>
                                <li>
                                    However sometimes you do not need them
                                    <pre><code data-trim>
                                        command: ls {{ nginx_conf_directory }
                                    </code></pre>

                                </li>
                            </ul>
                        </section>

                </section>
                <section>
                    <section>
                        <h2>
                            Iteration and Conditionals in Ansible
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Iteration and Conditionals in Ansible
                        </h3>
                        <pre><code data-trim>
                            $ cd $WORKDIR/sample-code/lesson3
                            $ tree
                            .
                             ansible
                              hosts
                              playbook-dict.yml
                              playbook-lists.yml
                             ansible.cfg
                        </code></pre>
                    </section>

                        <section>
                            <h2>
                                Iterating through lists
                            </h2>
                        </section>
                        <section>
                            <h3>
                                Iterating through lists
                            </h3>
                            <h4>
                                <code>with_items</code>
                            </h4>
                            <ul>
                                <li>Step through an array</li>
                                <li>Each element is assigned to variable <em>item</em></li>
                            </ul>
                            <pre><code data-trim>
                                - name: Process a list of items
                                  copy:
                                    src: "/path/to/local/{{ item }}"
                                    dest: "/path/to/remote/{{ item }}"
                                  with_items: "{{ list_of_files }}"
                            </code></pre>

                        </section>
                        <section>
                            <h3>
                                Configuring our fake application <em>myapp</em>
                            </h3>
                            
                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    Have a look at <code>ansible/playbook-lists.yml</code>
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Run the playbook and then have a look in
                                    /etc/myapp/config
                                </li>

                                <li class="fragment" data-fragment-index="2">
                                    It adds lines to a configuration file for a fake
                                    app
                                </li>
                                <li class="fragment" data-fragment-index="3">
                                    There are a number of things we can optimise
                                </li>
                            </ul>
                        </section>
                        <section>
                            <h4>
                                Exercise: Remove repetitive allowed_host(s) tasks from playbook
                            </h4>
                            <ul>
                                <li>
                                    Use <code>with_items</code> to simplify allowed_host tasks
                                </li>
                                <li class="fragment" data-fragment-index="0">
                                    Replace all the allowed host tasks with:
                                </li>
                            </ul>

                            <pre class="fragment" data-fragment-index="0"><code data-trim>
        - name: Add allowed_hosts entries
          lineinfile:
            path: /etc/myapp/config
            line: "allow_from: {{ item }}"
            insertafter: EOF
          with_items:
            - "{{ allowed_host1 }}"
            - "{{ allowed_host2 }}"
            - "{{ allowed_host3 }}"

                            </code></pre>

                        </section>
                        <section>
                            <h4>
                                Exercise: Remove repetitive listen tasks from playbook
                            </h4>
                            <ul>
                                <li>
                                    Use <code>with_items</code> to simplify listen tasks
                                </li>
                                <li class="fragment" data-fragment-index="0">
                                    Replace all the listen tasks with:
                                </li>
                            </ul>

                            <pre class="fragment" data-fragment-index="0"><code data-trim>

    - name: Add listen port entries
      lineinfile:
        path: /etc/myapp/config
        line: "listen: {{ item }}"
        insertafter: EOF
      with_items: "{{ listen_ports }}"
                            </code></pre>

                        </section>
                        <section>
                            <h3>
                                Nesting Loops
                            </h3>
                            <h4>
                                <code>with_nested</code>
                            </h4>
                            <ul style="width:100%;"><li>
                                    It is also possible to loop over two lists at once
                                    

                                </li></ul>
<pre><code data-trim>
                                    - name: Add allowed ports for each host
                                      lineinfile:
                                        path: /etc/myapp/config
                                        line: "host: {{ item[0] }}:{{ item[1] }}"
                                        insertafter: EOF
                                      with_nested:
                                        - [ "{{ allowed_host1 }}", "{{ allowed_host2 }}", "{{ allowed_host3 }}"]
                                        - "{{ listen_ports }}"
                                    </code></pre>


                        </section>

                        <section>
                            <h2>
                                Iterating through dictionaries
                            </h2>
                        </section>
                    
                        <section>
                            <h3>
                                Iterating through dictionaries
                            </h3>
                            <h4><code>with_dict</code></h4>
                            <ul>
                                <li>
                                    Takes a dictionary as argument
                                </li>
                                <li>
                                    Each item has
                                    <ul>
                                        <li>key</li>
                                        <li>value</li>
                                    </ul>
                                </li>
                            </ul>
                            <pre><code data-trim>
                                - name: Task that iterates over a dictionary
                                  somemodule:
                                    arg: "{{ item.key }}"
                                    arg2: "{{ item.value }}"
                                  with_dict: "{{ dictionary }}"
                            </code></pre>
                        </section>

                        <section><h3>
                                More configuration for myapp
                            </h3>
                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    <code>ansible/playbook-dict.yml</code> sets up
                                    database config for fake application
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Adds each element of <em>database</em>
                                    variable to config
                                </li>

                                <li class="fragment" data-fragment-index="2">
                                    Run the playbook and have a look at
                                    /etc/myapp/app_config 
                                </li>
                            </ul>

                        </section>

                        <section>
                            <h4>
                                Exercise: Remove repetition from playbook-dict.yml
                            </h4>
                            <ul>
                                
                                <li >
                                    Refactor playbook using <code>with_dict</code> to
                                    remove repetitive tasks.
                                </li>
                            </ul>
                            <pre class="fragment" data-fragment-index="0"><code data-trim>
                                - name: Add database config to /etc/myapp/config
                                  lineinfile:
                                    path: /etc/myapp/app_config
                                    line: "database_{{ item.key }}={{ item.value }}"
                                  with_dict: "{{ database[env_name] }}"
                            </code></pre>

                        </section>

                        <section>
                            <h2>
                                Conditionals
                            </h2>
                        </section>


                        <section>
                            <h3>
                                The <em>when</em> statement
                            </h3>

                            <ul>
                                <li class="fragment" data-fragment-index="0">
                                    The main way to conditionally do something in
                                    Ansible is to use the <em>when</em> statement
                                </li>
                                <li class="fragment" data-fragment-index="1">
                                    Identical semantics to a Python <em>if</em> block
                                    <ul>
                                        <li class="fragment" data-fragment-index="2">
                                            <code>when: some_variable is defined</code>
                                        </li>
                                        <li class="fragment" data-fragment-index="2">
                                            <code>when: env_name == 'staging'</code>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                            <pre class="fragment" data-fragment-index="4"><code data-trim>
                                - name: Some task
                                  command: do something
                                  when: &lt;condition is true&gt;
                            </code></pre>
                        </section>
                        
                        <section>
                            <h4>
                                Exercise: Make our tasks conditional 
                            </h4>
                            <ul>

                            <li>
                                Tasks in <code>ansible/playbook-dict.yml</code> assume a staging environment
                            </li>
                                <li>Add conditional to <code>lineinfile</code> task</li>
                                <li>Only execute if <code>env_name</code> is <em>production</em></li>
                                <li>
                                    re run the playbook
                                </li>
                            </ul>
                            
                            <pre  class="fragment" data-fragment-index="0"><code data-trim>
                                    - name: Add database config to /etc/myapp/config
                                      lineinfile:
                                      .
                                      .
                                      when: env_name == 'production'
                            </code></pre>


                        </section>
                        <section>
                            <h4>
                                Exercise: Override default <em>env_name</em> to run tasks
                            </h4>
                            <ul>
                                <li><em>env_name</em> is set to <em>staging</em> by default in vars section</li>
                                <li>Override this to be <em>production</em> and re-run playbook</li>
                                <li>Hint: What type of variable has precedence?</li>
                            </ul>
                            <pre  class="fragment" data-fragment-index="0"><code data-trim>
                                $ ansible-playbook ansible/playbook-dict.yml -K \
                                     -e env_name=production
                            </code></pre>
                        </section>
                        
                </section>
                <section>
                    <section>
                        <h2>Protecting Secrets in Ansible</h2>
                    </section>
                    <section>
                        <h3>
                            Protecting secrets in Ansible
                        </h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">One problem with playbook-dict.yml</li>
                            <li class="fragment" data-fragment-index="1">Database passwords are out in the open</li>
                            <li class="fragment" data-fragment-index="2">Ansible provides a built in tool for managing secrets</li>
                            <li class="fragment" data-fragment-index="3">
                                <code>ansible-vault</code> helps you
                                encrypt/decrypt files containing secrets for
                                your app
                            </li>
                        </ul>
                        <pre class="fragment" data-fragment-index="4"><code data-trim>
                            $ ansible-vault --help

                            Usage: ansible-vault [create|decrypt|edit|encrypt|encrypt_string|rekey|view] [options] [vaultfile.yml]

                            encryption/decryption utility for Ansible data files

                            Options:
                            --ask-vault-pass      ask for vault password
                            -h, --help            show this help message and exit
                        </code></pre>
                    </section>
                    <section>
                        <h3>
                            About Ansible Vault
                        </h3>
                        <ul>
                            <li>
                                Uses AES256 encryption
                            </li>
                            <li>
                                Secret files can be 
                                <ul>
                                    <li>Loaded automatically as <code>host_vars</code> or <code>group_vars</code> inventory files</li>
                                    <li>included <em>include_vars</em> or <em>vars_files</em></li>
                                </ul>
                            </li>
                            <li>
                                Encrypted files can be distributed with your
                                application
                            </li>
                        </ul>
                        
                    </section>
                    <section>
                        <h3>
                            Protecting our database passwords
                        </h3>
                        <ul style="width:90%;">
                            <li>
                                Create a new yml file:
                                <pre><code data-trim>
                                  $ $EDITOR $WORKDIR/sample-code/lesson3/ansible/secrets.yml
                                    ---
                                    vault_staging_database_password: &lt;some password&gt;
                                    vault_staging_database_password: &lt;some password&gt;
                                </code></pre>

                            </li>
                            <li>
                                Encrypt ansible/secrets.yml.
                                <pre><code data-trim>
                                    $ ansible-vault encrypt ansible/secrets.yml
                                    New Vault password: 
                                    Confirm New Vault password: 
                                    Encryption successful
                                </code></pre>
                                <ul>
                                    <li>
                                        Make sure you remember your password!
                                    </li>
                                </ul>
                            </li>
                            
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Integrating vaulted secrets
                        </h3>
                        <ul style="font-size:18pt;">
                            <li>
                                Import <code>secrets.yml</code> using vars_files
                                <pre style="font-size:18pt;"><code data-trim>
                                    vars_files:
                                      - secrets.yml
                                </code></pre>
                            </li>
                            <li>
                                Replace references to staging/production database
                                passwords
                                <pre style="font-size:18pt;"><code data-trim>
                                    database:
                                      staging:
                                        .
                                        password: "{{ vault_staging_database_password }}"
                                      production:
                                        .
                                        password: "{{ vault_production_database_password }}"
                                </code></pre>
                            </li>
                            <li>
                                Run playbook using <code style="color:red;">--ask-vault-pass</code> flag
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Summary
                        </h3>
                        <ul>
                            <li>
                               <code>ansible-vault</code> is a way to keep secrets safe
                                <ul>
                                    <li>passwords</li>
                                    <li>API keys</li>
                                    <li>SSL keys</li>
                                </ul>
                            </li>
                            <li>Can distribute encrypted secrets with your code</li>
                            <li>Automatically integrate into automation tasks</li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>
                            Deploying Software
                        </h2>
                    </section>

                    <section>
                        <h3>
                            Deploying Software
                        </h3>
                        
                        <pre><code data-trim>
                            $ cd $WORKDIR/sample-code/lesson4
                            $ tree
                            .
                             ansible
                            .
                            .
                             templates
                              index.html
                             wsgi.py

                        </code></pre>
                    </section>

                    <section>
                        <h3>
                            Catalyst Cloud
                        </h3>
                    </section>

                    <section>
                        <h3>
                            Provisioning Machines
                        </h3>
                        <p>
                        Let's provision 3 machines:
                        </p>
                        <dl>
                            <dt>App server</dt>
                            <dd>Runs a basic Flask (Python) app</dd>
                            <dt>DB server</dt>
                            <dd>Dedicated postgresql database</dd>
                            <dt>Web server</dt>
                            <dd>Nginx proxy requests to app server</dd>
                        </dl>
                    </section>

                </section>

<section>
                <section>
                    <h3>Running Ansible</h3>
                    <pre><code data-trim contenteditable>
$ ansible --version
ansible 2.4.2.0
  config file = None
  configured module search path
  .
  .
  python version = 2.7.12 (default, Nov 20 2017, 18:23:56) [GCC 5.4.0 20160609]
                    </code></pre>
                </section>
                <section>
                    <h3>Inline documentation</h3>
                    <pre><code data-trim contenteditable>
$ ansible --help
Usage: ansible <host-pattern> [options]

Define and run a single task 'playbook' against a set of hosts

Options:
  -a MODULE_ARGS, --args=MODULE_ARGS
                        module arguments
  -i INVENTORY, --inventory=INVENTORY, --inventory-file=INVENTORY
                        specify inventory host path or comma separated host
                        list. --inventory-file is deprecated
  --list-hosts          outputs a list of matching hosts; does not execute
                        anything else
  -m MODULE_NAME, --module-name=MODULE_NAME
                        module name to execute (default=command)
                    </code></pre>
                </section>
                <section>
                    <h3>Ad hoc commands</h3>
                    <pre><code data-trim contenteditable>
$ cat ansible/hosts
$ ansible -i ansible/hosts --list-hosts all
  hosts (1):
      localhost
                    </code></pre>
                </section>
                <section>
                    <h3>Ad hoc commands</h3>
                    <pre><code data-trim contenteditable>
$ ansible localhost -i hosts -m ping
localhost | SUCCESS => {
    "changed": false, 
    "ping": "pong"
}
                    </code></pre>
                </section>
                <section>
                    <h3>Ad hoc commands</h3>
                    <pre><code data-trim contenteditable>
$ ansible localhost -i hosts -a 'uname -a'
localhost | SUCCESS | rc=0 >>
Linux first-instance 3.13.0-135-generic #184-Ubuntu SMP Wed Oct 18 11:55:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
                    </code></pre>
                </section>
                </section>

                <section>
                <section>
                    <h3>What does Automation enable?</h3>
                    <ul>
                        <li>Immutable Infrastructure</li>
                        <li>Continuous Integration</li>
                        <li>Continuous Delivery</li>
                        <li>Continuous Deployment</li>
                        <li>A key DevOps practice</li>
                        <li>Essential to Microservice deployment at scale</li>
                    </ul>
                </section>
                <section>
                    <h3>Immutable Infrastructure</h3>
                    <ul>
                        <li><a href="https://blog.engineyard.com/2014/pets-vs-cattle">Cattle vs pets</a></li>
                        <li><a href="http://martinfowler.com/bliki/SnowflakeServer.html">Snowflake Servers</a> vs. <a href="http://martinfowler.com/bliki/PhoenixServer.html">Phoenix Servers</a></li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Cattle vs Pets</h2>
                    <img src="img/servers_pets_or_cattle.jpg" alt="Cattle vs Pets" height="600" width="800">
                </section>
                <section>
                    <h3>Immutable Infrastructure</h3>
                    <ul>
                        <li>The environment is defined in code (Infrastructure as Code)</li>
                        <li>If you need to change <em>anything</em> you create a new instance and destroy the old one</li>
                        <li>Stop Configuration Drift</li>
                        <li>Practice failure and iterate</li>
                        <li>Declarative</li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Immutable Infrastructure</h2>
                    <img src="img/immutable_infrastructure.gif" alt="Immutable Infrastructure" height="600" width="800">
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Blue-green deployments</h2>
                    <img src="img/blue_green_deployments.png" alt="Blue / Green Deployments" height="600" width="800">
                    <aside class="notes" >
                        Blue-green deployment is a technique that reduces downtime and risk by running two identical production environments called Blue and Green. At any time, only one of the environments is live, with the live environment serving all production traffic. For this example, Blue is currently live and Green is idle.
                    </aside>
                </section>
                <section>
                    <h3>Continuous integration</h3>
                    <ul>
                        <li>Trunk based development</li>
                        <li>Every developer commit triggers a merge/build/test cycle</li>
                        <li>Automated testing</li>
                    </ul>
                </section>
                <section>
                    <h3>Continuous delivery/deployment</h3>
                    <ul>
                        <li>Automated Pipeline from developer commit to production deploy</li>
                        <li>Requires lots of automated tests</li>
                        <li>Deploying more frequently lowers risk</li>
                    </ul>
                </section>
                <section>
                    <h3>Continuous delivery antipatterns</h3>
                    <ul>
                        <li>Deploying software manually</li>
                        <li>Manual configuration of production environments</li>
                        <li>Deploying to a production-like environment only after development is complete</li>
                    </ul>
                </section>
                <section class="image-slide">
                    <h2>DevOps</h2>
                    <img src="img/picture1_1.png" alt="DevOps" height="496" width="634">
                </section>
                <section class="image-slide">
                    <h2>DevOps</h2>
                    <img src="img/devops-common-use-cases-architectures-best-practices-22-638.jpg" alt="DevOps" height="359" width="638">
                </section>
                <section>
                    <h3>Microservices</h3>
                    <ul>
                        <li>Each microservice needs a full dev to prod pipeline</li>
                        <li>You have N microservices</li>
                        <li>Automation is the only reasonable way to achieve this</li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Netflix Microservices</h2>
                    <img src="img/netflix-microservices.jpg" alt="Netflix Microservices" height="600" width="800">
                </section>

                </section>
                <section>
                <section>
                    <h3>How automation helps organisations succeed</h3>
                    <ul>
                        <li>Achieve high deployment frequency</li>
                        <li>Decouple deployments from releases</li>
                    </ul>
                </section>
                <section>
                    <h3>High deployment frequency</h3>
                    <ul>
                        <li>Frequent releases of small features</li>
                        <li>Fast delivery of value to the customer</li>
                        <li>Per release risk is lower</li>
                        <li>Faster MTTR</li>
                        <li>Shorter feedback loops to validate value for users</li>
                    </ul>
                </section>
                <section>
                    <h3>Faster and better?</h3>
                    <p>Jez Humbles research on high performing organizations shows that faster and better is possible.</p>
                    <ul>
                        <li>Higher Quality</li>
                        <li>Faster Delivery</li>
                        <li>Greater Business Responsiveness</li>
                        <li>Reduced Costs</li>
                    </ul>
                </section>
                <section>
                    <h3>Whiteboard writeup</h3>
                    <p>Lets take a minute for everyone to come up to the whiteboard and write a word or phrase about automation.</p>
                </section>
                <section>
                    <h3>Recommended reading</h3>
                    <ul>
                        <li>Continuous Delivery by David Farley and Jez Humble</li>
                        <li>The DevOps Handbook by Gene Kim, Jez Humble, Patrick Debois and John Willis</li>
                        <li>Lean Enterprise by Barry O'Reilly, Jez Humble, and Joanne Molesky</li>
                        <li>The Phoenix Project by Gene Kim, George Spafford, and Kevin Behr</li>
                    </ul>
                </section>
                </section>


                <!--<section>
                <section>
                    <h3>Container Orchestration Engines</h3>
                    <ul>
                        <li>Provide a control plane or operating system on which to run containerised workloads</li>
                        <li>Infrastructure is abstracted so the DevOps team only cares about the application architecture and its scaling requirements</li>
                        <li>Runs on IaaS somewhere</li>
                    </ul>
                </section>
                <section>
                    <h3>Container Orchestration Engines</h3>
                    <p>"Kubernetes is an open-source system for automating deployment, operations, and scaling of containerized applications."</p>
                </section>
                <section>
                    <h3>Container Orchestration Engines</h3>
                    <ul>
                        <li>Kubernetes</li>
                        <li>Docker Swarm</li>
                        <li>Apache Mesos / DCOS</li>
                    </ul>
                </section>
                </section>-->

                


                

                <section>
                <section>
                    <h3>Simple playbook</h3>
                    <p>Open the file <strong>simple.yaml</strong>, read through the code and try and work out what you expect it to do. Try and think about if it will behave differently the second time you run it.</p>
                </section>
                <section>
                    <h3>Run the simple playbook</h3>
                    <pre><code data-trim contenteditable>
$ ansible-playbook -i hosts simple.yaml
                    </code></pre>
                </section>
                <section>
                    <h3>Simple playbook</h3>
                    <p>Run the playbook a few more times and observe the output</p>
                </section>
                <section>
                    <h3>Things to try</h3>
                    <ul>
                        <li>Manually remove the file <strong>/home/train/ansible-files/copy-example.txt</strong> and re-run the playbook</li>
                        <li>Manually remove the directory <strong>/home/train/ansible-files/</strong> and re-run the playbook</li>
                        <li>Change the value of the <strong>foo</strong> variable and re-run the playbook</li>
                        <li>Comment out a task and re-run the playbook</li>
                    </ul>
                </section>
                <section>
                    <h3>Things to notice</h3>
                    <ul>
                        <li>There is an extra task called <strong>Gathering Facts</strong> that we did not explicitly add</li>
                        <li>Changed tasks are also ok tasks (see the <strong>PLAY RECAP</strong>)</li>
                        <li>Look at the where we are using <strong>register:</strong>, do you see how that works?</li>
                    </ul>
                </section>
                <section>
                    <h3>Idempotence Revisited</h3>
                    <ul>
                        <li>Make the same request repeatedly to produce the same result</li>
                        <li>ok = I checked and the thing you wanted was already done so I skipped doing it</li>
                        <li>changed = I checked and the thing you wanted was not done so I did it</li>
                    </ul>
                    <pre><code data-trim contenteditable>
PLAY RECAP *********************************************************************
localhost                  : ok=6    changed=4    unreachable=0    failed=0

...

PLAY RECAP *********************************************************************
localhost                  : ok=6    changed=0    unreachable=0    failed=0
                    </code></pre>
                </section>
                <section>
                    <h3>Add a new task</h3>
                    <ul>
                        <li>Consult the <a href="https://docs.ansible.com/ansible/latest/modules_by_category.html">documentation</a></li>
                        <li>There are a number of good candidates in the <a href="https://docs.ansible.com/ansible/latest/list_of_files_modules.html">files section</a>:</li>
                        <ul>
                            <li>archive</li>
                            <li>blockinfile / lineinfile</li>
                            <li>stat</li>
                            <li>replace</li>
                        </ul>
                    </ul>
                </section>
                <section>
                    <h3>Add the following task</h3>
                    <pre><code data-trim contenteditable>
  - name: Install the mtr package
    apt:
      name: mtr
                    </code></pre>
                </section>
                <section>
                    <h3>Run the task</h3>
                    <ul>
                        <li>What happened?</li>
                        <li>How can we fix it?</li>
                        <li>See if you can <a href="https://docs.ansible.com/ansible/latest/become.html">consult the documentation</a> to get this task working</li>
                    </ul>
                </section>
                </section>

                <section>
                <section>
                    <h3>What is Cloud Computing?</h3>
                    <p>The NIST Definition of Cloud Computing lists five essential characteristics of Cloud Computing:</p>
                    <ul>
                        <li>On-demand self-service</li>
                        <li>Broad network access</li>
                        <li>Resource pooling</li>
                        <li>Rapid elasticity</li>
                        <li>Measured service</li>
                    </ul>
                </section>
                <section>
                    <h3>On-demand self-service</h3>
                    <p>A consumer can unilaterally provision computing capabilities, such as server time and network storage, as needed automatically without requiring human interaction with each service provider.</p>
                </section>
                <section>
                    <h3>Broad network access</h3>
                    <p>Capabilities are available over the network and accessed through standard mechanisms that promote use by heterogeneous thin or thick client platforms (e.g., mobile phones, tablets, laptops, and workstations).</p>
                </section>
                <section>
                    <h3>Resource pooling</h3>
                    <p>The provider's computing resources are pooled to serve multiple consumers using a multi-tenant model, with different physical and virtual resources dynamically assigned and reassigned according to consumer demand. There is a sense of location independence in that the customer generally has no control or knowledge over the exact location of the provided resources but may be able to specify location at a higher level of abstraction (e.g., country, state, or datacenter). Examples of resources include storage, processing, memory, and network bandwidth.</p>
                </section>
                <section>
                    <h3>Rapid elasticity</h3>
                    <p>Capabilities can be elastically provisioned and released, in some cases automatically, to scale rapidly outward and inward commensurate with demand. To the consumer, the capabilities available for provisioning often appear to be unlimited and can be appropriated in any quantity at any time.</p>
                </section>
                <section>
                    <h3>Measured service</h3>
                    <p>Cloud systems automatically control and optimize resource use by leveraging a metering capability at some level of abstraction appropriate to the type of service (e.g., storage, processing, bandwidth, and active user accounts). Typically this is done on a pay-per-use or charge-per-use basis. Resource usage can be monitored, controlled, and reported, providing transparency for both the provider and consumer of the utilized service.</p>
                </section>
                </section>

                <section>
                <section>
                    <h3>The Big 3</h3>
                    <ul>
                        <li>AWS</li>
                        <li>Azure</li>
                        <li>Google Cloud Platform</li>
                    </ul>
                </section>
                <section>
                    <h3>What is OpenStack?</h3>
                    <ul>
                        <li>A "cloud operating system"</li>
                        <li>Sits above your infrastructure providing IaaS</li>
                        <li>Provides an API to interact with that infrastructure</li>
                        <li>API provides operations like Create/Delete/Update for various components</li>
                        <li>Command line tools, libraries, dashboard all interact with services via the API</li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>What is OpenStack?</h2>
                    <img src="img/Openstack-software-diagram.png" alt="Openstack-software-diagram">
                </section>
                <section>
                    <h3>OpenStack services</h3>
                    <ul>
                        <li>Dashboard (Horizon)</li>
                        <li>Compute (Nova)</li>
                        <li>Networking (Neutron)</li>
                        <li>Object Storage (Swift)</li>
                        <li>Block Storage (Cinder)</li>
                        <li>Identity Service (Keystone)</li>
                        <li>Image Service (Glance)</li>
                        <li>Telemetry Service (Ceilometer)</li>
                        <li>Orchestration Service (Heat)</li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Openstack Architecture</h2>
                    <img src="img/Openstack_havana_conceptual_arch.png" alt="Openstack_conceptual_arch" height="600" width="800">
                </section>
                </section>

                <section>
                <section>
                    <h3>First Instance using Ansible</h3>
                    <ul>
                        <li><a href="http://docs.catalystcloud.io/first-instance/ansible.html">http://docs.catalystcloud.io/first-instance/ansible.html</a></li>
                        <li>Clone catalystcloud-ansible repo</li>
                        <li>Install Ansible</li>
                        <li>Edit launch-instance and create-network playbooks</li>
                        <li>Add a prefix (yourname)</li>
                    </ul>
                </section>
                <section>
                    <h3>Training room settings</h3>
                    <ul>
                        <li>Prefix all resource names with yourname-</li>
                        <li>eg: yourname-border-router, yourname-private-net</li>
                        <li>Do this in all three files by editing <strong>prefix_name</strong></li>
                        <ul>
                            <li>example-playbooks/create-network.yml</li>
                            <li>example-playbooks/launch-instance.yml</li>
                            <li>example-playbooks/remove-stack.yml</li>
                        </ul>
                    </ul>
                </section>
                <section>
                    <h3>First Instance using Ansible</h3>
                    <ul>
                        <li>Create an SSH Keypair</li>
                        <li>Login to the <a href="https://dashboard.cloud.catalyst.net.nz/">dashboard</a></li>
                        <li>Follow the instructions to download an <a href="http://docs.catalystcloud.io/getting-started/cli.html#source-rc-file">OpenStack RC file</a></li>
                        <li>Follow the instructions to run the create network and launch instance playbooks.</li>
                    </ul>
                </section>
                <section>
                    <h3>Create an SSH keypair</h3>
                    <pre><code data-trim contenteditable>
$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/train/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/train/.ssh/id_rsa.
Your public key has been saved in /home/train/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:1K16QYwSmm2IAyHQBVXj19NW91v1SRbjtKzun6IsEjE train@train01
The key's randomart image is:
+---[RSA 2048]----+
|*o.+o.+       .*+|
|.... * o = o .*.B|
|  o + = + * +  =+|
|   . . E . +  . o|
|        S o  . . |
|       . . ..    |
|        o .  .   |
|       . o. ..  .|
|        . .o..oo |
+----[SHA256]-----+
                    </code></pre>
                </section>
                <section>
                    <h3>First Instance using Ansible</h3>
                    <ul>
                        <li>Create an SSH Keypair</li>
                        <li>Login to the <a href="https://dashboard.cloud.catalyst.net.nz/">dashboard</a></li>
                        <li>Follow the instructions to download an <a href="http://docs.catalystcloud.io/getting-started/cli.html#source-rc-file">OpenStack RC file</a></li>
                        <li>Follow the instructions to run the create network and launch instance playbooks.</li>
                    </ul>
                </section>
                <section>
                    <h3>SSH to your instance</h3>
                    <ul>
                        <li>You should now be able to SSH to your cloud instance.</li>
                        <li>If you are having trouble consult the <a href="http://docs.catalystcloud.io/network.html#why-can-t-i-ssh-to-my-instance">FAQ</a></li>
                    </ul>
                </section>
                </section>

                <section>
                <section>
                    <h3>Running your own website</h3>
                    <p>We are going to create a website on the internet</p>
                </section>
                <section>
                    <h3>Website creation steps - Done</h3>
                    <ul>
                        <li>Create a server Ansible (including Security Groups, SSH Keys and Floating IPs)</li>
                        <li>Ensure that you can connect to the server using SSH</li>
                    </ul>
                </section>
                <section>
                    <h3>Website creation steps</h3>
                    <ul>
                        <li>Create a static website on your local machine using <a href="https://gohugo.io/">Hugo</a></li>
                        <li>Configure DNS for the site (trainer)</li>
                        <li>Upload the website to the server</li>
                        <li>Configure a webserver (Nginx) to serve up the static site on the internet</li>
                    </ul>
                </section>
                <section>
                    <h3>Create a static website</h3>
                    <ul>
                        <li>Follow the instructions at <a href="https://gohugo.io/overview/quickstart/">https://gohugo.io/overview/quickstart/</a> to create a static website</li>
                        <li>Call your site something unique rather than <strong>bookshelf</strong></li>
                        <li>Choose a <a href="http://themes.gohugo.io/">theme</a> to use</li>
                        <li>Step 7: baseurl = "http://train01.nz/"</li>
                        <li>Skip Steps 8, 10 and 12</li>
                    </ul>
                </section>
                <section>
                    <h3>Hugo commands 1</h3>
                    <pre><code data-trim contenteditable>
$ wget https://github.com/gohugoio/hugo/releases/download/v0.31.1/hugo_0.31.1_Linux-64bit.deb
$ sudo dpkg -i hugo_0.31.1_Linux-64bit.deb
$ hugo new site quickstart
$ cd quickstart/
$ git init
$ git submodule add https://github.com/budparr/gohugo-theme-ananke.git themes/ananke
$ echo 'theme = "ananke"' >> config.toml
                    </code></pre>
                </section>
                <section>
                    <h3>Hugo commands 2</h3>
                    <pre><code data-trim contenteditable>
$ hugo new posts/my-first-post.md
$ echo "This is my first post!" &gt;&gt; content/posts/my-first-post.md
$ hugo server -D
Press Ctrl+C to stop
                    </code></pre>
                </section>
                <section>
                    <h3>Hugo commands 3</h3>
                    <pre><code data-trim contenteditable>
$ vi config.toml
$ cat config.toml
baseURL = "http://train01.nz/"
languageCode = "en-nz"
title = "Ansible Training"
theme = "ananke"
$ hugo undraft content/posts/my-first-post.md
$ hugo
$ # static html is now stored in public folder
                    </code></pre>
                </section>
                <section>
                    <h3>Configure name resolution</h3>
                    <p>Edit your /etc/hosts to enable name resolution for your site</p>
                    <pre><code data-trim contenteditable>
$ sudo vi /etc/hosts
$ tail -n 1 /etc/hosts
150.242.42.156 train01.nz
                    </code></pre>
                </section>
                <section>
                    <h3>Upload the website</h3>
                    <p>Copy the public directory to the webserver</p>
                    <pre><code data-trim contenteditable>
$ cd quickstart/
$ scp -r public/ ubuntu@150.242.42.156:
                    </code></pre>
                </section>
                <section>
                    <h3>Configure the webserver</h3>
                    <pre><code data-trim contenteditable>
$ ssh ubuntu@150.242.42.156
$ sudo apt install nginx
$ cd public
$ sudo mv * /var/www/html
$ sudo chown -R root:root /var/www/html
                    </code></pre>
                </section>
                <section>
                    <h3>Visit your site</h3>
                    <ul>
                        <li><a href="http://train01.nz">http://train01.nz</a></li>
                        <li>Is it working?</li>
                        <li>Can you think why it may not be working?</li>
                        <li>What action could we do to get it working?</li>
                    </ul>
                </section>
                </section>

                <section>
                <section>
                    <h3>Localhost?</h3>
                    <ul>
                        <li>Cloud modules are localhost tasks</li>
                        <li>Modules make API calls in the background</li>
                        <li>OpenStack modules use shade (cf. boto3)</li>
                        <li>Ring your mother and ask her to put the kettle on</li>
                    </ul>
                </section>
                <section>
                    <h3>Cloud Modules</h3>
                    <p><a href="https://docs.ansible.com/ansible/list_of_cloud_modules.html">https://docs.ansible.com/ansible/list_of_cloud_modules.html</a></p>
                </section>
                </section>

                <section>
                <section>
                    <h3>Cleanup and start again</h3>
                    <ul>
                        <li>Run the remove-stack.yml playbook</li>
                        <li>Remove the entry from /etc/hosts</li>
                        <li>Run create-network.yml</li>
                        <li>Run launch-instance.yml</li>
                    </ul>
                </section>
                <section>
                    <h3>Write a playbook that does the following</h3>
                    <ul>
                        <li>Adds a line to /etc/hosts on localhost</li>
                        <li>Installs nginx on the server</li>
                        <li>Copies the hugo public directory to /var/www/html on the server</li>
                    </ul>
                </section>
                </section>

                <section>
                    <h3>Ansible Vault</h3>
                    <ul>
                        <li>A feature that allows keeping passwords and keys in encrypted files</li>
                        <li>ansible-vault command line tool for editing files</li>
                        <li>--ask-vault-pass or --vault-password-file when used with ansible-playbook</li>
                        <li>A feature that allows keeping passwords and keys in encrypted files</li>
                    </ul>
                </section>

                <section>
                    <h3>Best Practices</h3>
                    <ul>
                        <li>Review this best practice <a href="https://www.ansible.com/blog/ansible-best-practices-essentials">blog post</a></li>
                        <li>Edit best-practice.yml to conform to best practices</li>
                    </ul>
                </section>

                <section>
                    <h3>Roles and Includes</h3>
                    <ul>
                        <li><a href="https://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html">Roles</a></li>
                        <li><a href="https://docs.ansible.com/ansible/latest/playbooks_reuse.html">Creating Reusable Playbooks</a></li>
                        <li><a href="https://docs.ansible.com/ansible/latest/playbooks_reuse_includes.html">Including and Importing</a></li>
                    </ul>
                </section>

            </div>

            <!--<div class="footer">
                <div class="scarf">
                    <div class="scarf-orange"></div>
                    <div class="scarf-yellow"></div>
                    <div class="scarf-blue"></div>
                    <div class="scarf-green"></div>
                </div>
                <div class="footer-inner">
                    <div class="catalyst-logo-footer">Catalyst</div>
                    [> NOTE: use only one of these. open-source-technologists is the standard <]
                    <div class="open-source-technologists">open source technologists</div>
                    [> <div class="freedom-to-innovate">freedom to innovate</div> <]
                </div>
            </div>-->
        </div>


        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>
        <script src="js/asciinema-player.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
